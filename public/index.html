<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOREST HR â€” Boshqaruv paneli</title>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="/index.css">
    <script src="/js/mobile-menu.js" defer></script>
    
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="/uploads/Logo/22.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; padding: 8px;">
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                <h2>FOREST HR</h2>
                <p class="subtitle">Xo'jaliklar aro nazorat tizimi</p>
            </div>
        </div>
        <div class="sidebar-menu-label"
            style="padding: 12px 20px 4px 20px; color: #94a3b8; font-size: 0.65rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">
            ASOSIY MENYU</div>
        <ul class="sidebar-menu">
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link active" data-section="dashboard">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                        </svg>
                    </span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link" data-section="organizations">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z" />
                        </svg>
                    </span>
                    <span>Tashkilotlar</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link" data-section="departments">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                        </svg>
                    </span>
                    <span>Bo'limlar</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link" data-section="positions">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                        </svg>
                    </span>
                    <span>Lavozimlar</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link" data-section="employees">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg>
                    </span>
                    <span>Xodimlar</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link" data-section="settings">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                        </svg>
                    </span>
                    <span>Sozlamalar</span>
                </a>
            </li>
            <li class="sidebar-menu-item" id="addAdminMenuItem" style="display: none;">
                <a href="#" class="sidebar-menu-link" id="addAdminBtn">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor" />
                        </svg>
                    </span>
                    <span>Admin qo'shish</span>
                </a>
            </li>
            <li class="sidebar-menu-item">
                <a href="#" class="sidebar-menu-link" id="sidebarLogoutBtn" style="color: #ef4444;">
                    <span class="sidebar-menu-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.59-5.41L6.17 4.17C4.23 5.82 3 8.78 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-3.22-1.23-6.18-3.17-8.83z" />
                        </svg>
                    </span>
                    <span>Chiqish</span>
                </a>
            </li>
        </ul>
        <div class="sidebar-footer">
            <div
                style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; color: #ffffff;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                    style="width: 20px; height: 20px; fill: #10b981; flex-shrink: 0;">
                    <path
                        d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" />
                </svg>
                <a href="tel:+998915855533"
                    style="color: #ffffff; text-decoration: none; font-size: 0.875rem; font-weight: 500; display: flex; align-items: center;">+998
                    91 585-55-33</a>
            </div>
            <p class="sidebar-footer-text" style="margin: 0; line-height: 1.5;">FORESTDIGITAL Â© 2026.<br>Designed & Developed By Akbarali</p>
        </div>
    </div>

    <button type="button" class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menyu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-content">
        <div class="container" id="dashboardSection">
            <div class="header" id="globalHeader">
                <div class="header-left">
                    <h1 id="pageTitle">Asosiy Dashboard</h1>
                    <p id="pageBreadcrumb">Admin / Asosiy Dashboard</p>
                </div>
                <div class="header-right">
                    <div class="email-icon-container" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                        onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                            style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                            <polyline points="22,6 12,13 2,6" />
                        </svg>
                        <span class="notification-badge" id="emailBadge" style="display: none;">0</span>
                    </div>
                    <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                        onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                            style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                        </svg>
                        <div style="position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 2px solid #ffffff;"></div>
                    </div>
                    <div class="language-selector" id="languageSelector" style="display: flex; align-items: center; gap: 8px; margin-right: 8px; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; height: 40px; box-sizing: border-box; position: relative;"
                        onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px; fill: #6b7280;">
                            <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                        </svg>
                        <span id="currentLanguage" style="font-size: 0.875rem; font-weight: 500; color: #6b7280;">O'z</span>
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: #6b7280; margin-left: 4px;">
                            <path d="M7 10l5 5 5-5z" />
                        </svg>
                        <div class="language-dropdown" id="languageDropdown" style="display: none; position: absolute; top: 48px; left: 0; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 120px; padding: 8px 0;">
                            <div class="language-option" onclick="changeLanguage('uz')" style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">O'z</span>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ru')" style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Ru</span>
                            </div>
                            <div class="language-option" onclick="changeLanguage('en')" style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Eng</span>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-user-profile" id="userProfileBtn" onclick="openSuperAdminInfoModal()"
                        style="margin: 0; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); height: 40px; box-sizing: border-box; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';">
                        <div class="sidebar-user-icon"
                            style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent; border-radius: 50%;">
                            <img src="/uploads/Icoonlar/galochka-3d-icon-png-download-11169918.webp" alt="User Icon"
                                style="width: 24px; height: 24px; object-fit: contain;">
                        </div>
                        <div class="sidebar-user-info" style="flex: 1; min-width: 0;">
                            <div class="sidebar-user-name" id="dashboardUserName"
                                style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px;">
                                A.Turdiyev</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-cards">
                <div class="status-card">
                    <div class="status-card-content"
                        style="flex: 1; padding: 0; display: flex; flex-direction: column;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%;">
                            <div class="status-card-label"
                                style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                UMUMIY STATISTIKA</div>
                        </div>

                        <!-- Arc Chart (Full Circle) -->
                        <div
                            style="position: relative; width: 100%; height: 220px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                            <svg width="200" height="200" viewBox="0 0 200 200" style="overflow: visible;">
                                <!-- Arc segments - full circle (3 colors only) -->
                                <path id="arc-ontime" d="" fill="none" stroke="#10b981" stroke-width="20"
                                    stroke-linecap="round" />
                                <path id="arc-late" d="" fill="none" stroke="#f59e0b" stroke-width="20"
                                    stroke-linecap="round" />
                                <path id="arc-absent" d="" fill="none" stroke="#6b7280" stroke-width="20"
                                    stroke-linecap="round" />
                            </svg>
                            <div
                                style="position: absolute; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 4px;">Jami xodimlar</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #111827;">
                                    <span id="statTotalCame">0</span>/<span id="statTotalAll">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Status Breakdown - Vertical List -->
                        <div
                            style="display: flex; flex-direction: column; gap: 0; width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div
                                        style="width: 12px; height: 12px; border-radius: 50%; background: #10b981; flex-shrink: 0;">
                                    </div>
                                    <div style="font-size: 0.9rem; color: #111827; font-weight: 500;">Vaqtida keldi
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #111827;">
                                    <span id="statOntimePercent">0</span>%
                                </div>
                            </div>
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div
                                        style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b; flex-shrink: 0;">
                                    </div>
                                    <div style="font-size: 0.9rem; color: #111827; font-weight: 500;">Kechikdi</div>
                                </div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #111827;">
                                    <span id="statLatePercent">0</span>%
                                </div>
                            </div>
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div
                                        style="width: 12px; height: 12px; border-radius: 50%; background: #6b7280; flex-shrink: 0;">
                                    </div>
                                    <div style="font-size: 0.9rem; color: #111827; font-weight: 500;">Kelmagan</div>
                                </div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: #111827;">
                                    <span id="statAbsentPercent">0</span>%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Department Statistics Card -->
                <div class="status-card">
                    <div class="status-card-content"
                        style="flex: 1; padding: 0; display: flex; flex-direction: column; align-items: flex-start;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%;">
                            <div class="status-card-label"
                                style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                Markaziy bo'linmalar</div>
                        </div>
                        <div class="bar-chart-container" id="departmentChartContainer"
                            style="margin-top: 0; width: 100%; flex: 1; min-height: 0; overflow-y: auto; padding-right: 4px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start;">
                            <div style="text-align: center; color: #6b7280;">Ma'lumotlar yig'ilmoqda...</div>
                        </div>
                    </div>
                </div>

                <!-- Active Employees Card -->
                <div class="status-card status-card-faol">
                    <div class="status-card-content active-employee-card-wrapper"
                        style="flex: 1; padding: 0; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; width: 100%; flex-shrink: 0;">
                            <div class="status-card-label"
                                style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                Faol xodimlar</div>
                        </div>
                        <div class="active-employee-list" id="activeEmployeesList">
                            <div style="text-align: center; color: #6b7280;">Ma'lumotlar yig'ilmoqda...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="employees-header">
                <div class="employees-title">Markaziy aparat</div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="time-filter">
                        <select class="filter-select" id="periodSelect">
                            <option value="daily" selected>Kunlik</option>
                            <option value="weekly">Haftalik</option>
                            <option value="yearly">Yillik</option>
                        </select>
                    </div>
                    <div class="time-filter">
                        <select class="filter-select" id="statusFilter">
                            <option value="all" selected>Hammasi</option>
                            <option value="ontime">Vaqtida keldi</option>
                            <option value="late">Kechikdi</option>
                            <option value="absent">Kelmagan</option>
                        </select>
                    </div>
                    <button class="export-btn" id="exportBtn" title="Export to Excel">
                        <span>ðŸ“¥</span> Excel'ga eksport qilish
                    </button>
                    <div class="search-container" style="width: 180px;">
                        <input type="text" class="search-input" id="searchInput" placeholder="Qidirish..."
                            autocomplete="off">
                        <span class="search-icon">âŒ•</span>
                    </div>
                </div>
            </div>

            <div class="employees-table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">ID</th>
                            <th style="width: 50px;">Rasm</th>
                            <th>Ism</th>
                            <th style="width: 150px;">BO'LIM</th>
                            <th style="width: 150px;">LAVOZIM</th>
                            <th style="width: 150px;">TELEFON</th>
                            <th style="width: 180px;">EMAIL</th>
                            <th style="width: 100px;">Sana</th>
                            <th style="width: 120px;">Kelish vaqti</th>
                            <th style="width: 120px;">Ketish vaqti</th>
                            <th style="width: 130px;">HOLATI</th>
                            <th style="width: 150px;">STATUS</th>
                            <th style="width: 80px;">KPI %</th>
                        </tr>
                    </thead>
                    <tbody id="employeesBody">
                        <tr>
                            <td colspan="11" class="empty-row">AccessControl hodisalarini kutish...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Organizations Section -->
        <div id="organizationsSection" class="content-section" style="display: none;">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: #111827; letter-spacing: -0.3px;">
                            Tashkilotlar
                        </h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">
                            Admin / Tashkilotlar
                        </p>
                    </div>
                    <div class="header-right">
                        <div class="email-icon-container" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                <polyline points="22,6 12,13 2,6" />
                            </svg>
                            <span class="notification-badge" id="orgEmailBadge" style="display: none;">0</span>
                        </div>
                        <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                            </svg>
                            <div style="position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 2px solid #ffffff;"></div>
                        </div>
                        <div class="language-selector"
                            style="display: flex; align-items: center; gap: 8px; margin-right: 8px; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; height: 40px; box-sizing: border-box;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 18px; height: 18px; fill: #6b7280;">
                                <path
                                    d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                            </svg>
                            <span id="orgCurrentLanguage"
                                style="font-size: 0.875rem; font-weight: 500; color: #6b7280;">O'z</span>
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 16px; height: 16px; fill: #6b7280; margin-left: 4px;">
                                <path d="M7 10l5 5 5-5z" />
                            </svg>
                        </div>
                        <div class="language-dropdown" id="orgLanguageDropdown"
                            style="display: none; position: absolute; top: 60px; right: 24px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 120px; padding: 8px 0;">
                            <div class="language-option"
                                onclick="changeLanguage('uz', 'orgCurrentLanguage', 'orgLanguageDropdown')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">O'z</span>
                            </div>
                            <div class="language-option"
                                onclick="changeLanguage('ru', 'orgCurrentLanguage', 'orgLanguageDropdown')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Ru</span>
                            </div>
                            <div class="language-option"
                                onclick="changeLanguage('en', 'orgCurrentLanguage', 'orgLanguageDropdown')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Eng</span>
                            </div>
                        </div>
                        <div class="sidebar-user-profile" onclick="openSuperAdminInfoModal()"
                            style="margin: 0; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); height: 40px; box-sizing: border-box; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.15)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';">
                            <div class="sidebar-user-icon"
                                style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent;">
                                <img src="/uploads/Icoonlar/galochka-3d-icon-png-download-11169918.webp" alt="User Icon"
                                    style="width: 22px; height: 22px; object-fit: contain; background: transparent;">
                            </div>
                            <div class="sidebar-user-info" style="flex: 1; min-width: 0;">
                                <div class="sidebar-user-name" id="orgDashboardUserName"
                                    style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px;">
                                    A.Turdiyev</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="employees-header">
                    <div class="employees-title">Tashkilotlar</div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="time-filter">
                            <select class="filter-select" id="orgPeriodSelect">
                                <option value="all" selected>Hammasi</option>
                            </select>
                        </div>
                        <button class="export-btn" id="orgExportBtn" title="Export to Excel"><span>ðŸ“¥</span> Excel'ga eksport qilish</button>
                        <div class="search-container" style="width: 180px;">
                            <input type="text" class="search-input" id="orgSearchInput" placeholder="Qidirish..." autocomplete="off">
                            <span class="search-icon">âŒ•</span>
                        </div>
                        <button id="createOrgBtn" class="btn-create-org"><span>âž•</span> Tashkilot qo'shish</button>
                    </div>
                </div>

                <div class="employees-table-container" id="organizationsList">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">â„–</th>
                                <th>Tashkilot nomi</th>
                                <th style="width: 120px;">Xodimlari soni</th>
                                <th style="width: 140px;">Telefon</th>
                                <th style="width: 180px;">Email</th>
                                <th class="admin-only" style="width: 120px;">Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="organizationsTableBody">
                            <tr>
                                <td colspan="6" class="empty-row">Tashkilotlar yig'ilmoqda...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Departments Section -->
        <div id="departmentsSection" class="content-section" style="display: none;">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: #111827; letter-spacing: -0.3px;">Bo'limlar</h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Admin / Bo'limlar</p>
                    </div>
                    <div class="header-right">
                        <div style="display: flex; align-items: center; gap: 8px; margin-right: 8px;">
                            <div style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                                onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                                onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                    style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                    <polyline points="22,6 12,13 2,6" />
                                </svg>
                            </div>
                            <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                                onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                                onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                    style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                                </svg>
                                <div
                                    style="position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 2px solid #ffffff;">
                                </div>
                            </div>
                        </div>
                        <div class="language-selector"
                            style="display: flex; align-items: center; gap: 8px; margin-right: 8px; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; height: 40px; box-sizing: border-box;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 18px; height: 18px; fill: #6b7280;">
                                <path
                                    d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                            </svg>
                            <span id="deptCurrentLanguage"
                                style="font-size: 0.875rem; font-weight: 500; color: #6b7280;">O'z</span>
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 16px; height: 16px; fill: #6b7280; margin-left: 4px;">
                                <path d="M7 10l5 5 5-5z" />
                            </svg>
                        </div>
                        <div class="language-dropdown" id="deptLanguageDropdown"
                            style="display: none; position: absolute; top: 60px; right: 24px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 120px; padding: 8px 0;">
                            <div class="language-option"
                                onclick="changeLanguage('uz', 'deptCurrentLanguage', 'deptLanguageDropdown')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">O'z</span>
                            </div>
                            <div class="language-option"
                                onclick="changeLanguage('ru', 'deptCurrentLanguage', 'deptLanguageDropdown')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Ru</span>
                            </div>
                            <div class="language-option"
                                onclick="changeLanguage('en', 'deptCurrentLanguage', 'deptLanguageDropdown')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Eng</span>
                            </div>
                        </div>
                        <div class="sidebar-user-profile" onclick="openSuperAdminInfoModal()"
                            style="margin: 0; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); height: 40px; box-sizing: border-box; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.15)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';">
                            <div class="sidebar-user-icon"
                                style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent;">
                                <img src="/uploads/Icoonlar/galochka-3d-icon-png-download-11169918.webp" alt="User Icon"
                                    style="width: 22px; height: 22px; object-fit: contain; background: transparent;">
                            </div>
                            <div class="sidebar-user-info" style="flex: 1; min-width: 0;">
                                <div class="sidebar-user-name" id="deptDashboardUserName"
                                    style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px;">
                                    A.Turdiyev</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="employees-header">
                    <div class="employees-title">Bo'limlar</div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="time-filter">
                            <select class="filter-select" id="deptPeriodSelect">
                                <option value="all" selected>Hammasi</option>
                            </select>
                        </div>
                        <button class="export-btn" id="deptExportBtn" title="Export to Excel"><span>ðŸ“¥</span> Excel'ga eksport qilish</button>
                        <div class="search-container" style="width: 180px;">
                            <input type="text" class="search-input" id="deptSearchInput" placeholder="Qidirish..." autocomplete="off">
                            <span class="search-icon">âŒ•</span>
                        </div>
                        <button id="createDeptBtn" class="btn-create-org"><span>âž•</span> Yangi bo'lim</button>
                    </div>
                </div>

                <div class="employees-table-container" id="departmentsList">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">â„–</th>
                                <th>Bo'lim nomi</th>
                                <th style="width: 150px;">Tashkilot</th>
                                <th>Tavsif</th>
                                <th class="admin-only" style="width: 120px;">Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="departmentsTableBody">
                            <tr>
                                <td colspan="5" class="empty-row">Bo'limlar yig'ilmoqda...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create/Edit Organization Modal -->
        <div id="organizationModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #ffffff;">
                    <div class="header-left">
                        <h1 id="organizationModalTitle"
                            style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #111827;">Tashkilot qo'shish
                        </h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Tashkilotlar
                            / Tashkilot qo'shish</p>
                    </div>
                    <span class="modal-close" id="closeOrgModal"
                        style="cursor: pointer; font-size: 24px; color: #6b7280; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#111827';"
                        onmouseout="this.style.background=''; this.style.color='#6b7280';">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="organizationForm">
                        <input type="hidden" id="orgId" name="orgId">

                        <div class="form-group">
                            <label for="orgName">Tashkilot nomi *</label>
                            <input type="text" id="orgName" name="orgName" required
                                placeholder="Tashkilot nomini kiriting" autocomplete="organization">
                        </div>

                        <div class="form-group">
                            <label for="orgEmployeeCount">Xodimlari soni</label>
                            <input type="number" id="orgEmployeeCount" name="orgEmployeeCount" min="0" step="1"
                                placeholder="0" value="0">
                        </div>

                        <div class="form-group">
                            <label for="orgPhone">Telefon raqami</label>
                            <input type="tel" id="orgPhone" name="orgPhone" placeholder="Telefon raqamini kiriting"
                                autocomplete="tel">
                        </div>

                        <div class="form-group">
                            <label for="orgEmail">Email</label>
                            <input type="email" id="orgEmail" name="orgEmail" placeholder="Email manzilini kiriting"
                                autocomplete="email">
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn-cancel" id="cancelOrgBtn">Bekor qilish</button>
                            <button type="submit" class="btn-save">Saqlash</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Admin User Modal -->
        <div id="addAdminModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #ffffff;">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #111827;">Admin qo'shish</h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Admin /
                            Admin qo'shish</p>
                    </div>
                    <span class="modal-close" id="closeAddAdminModal"
                        style="cursor: pointer; font-size: 24px; color: #6b7280; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#111827';"
                        onmouseout="this.style.background=''; this.style.color='#6b7280';">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm">
                        <div class="form-group">
                            <label for="adminUsername">Username *</label>
                            <input type="text" id="adminUsername" name="adminUsername" required
                                placeholder="Username kiriting" autocomplete="username">
                        </div>

                        <div class="form-group">
                            <label for="adminPassword">Password *</label>
                            <input type="password" id="adminPassword" name="adminPassword" required
                                placeholder="Password kiriting" autocomplete="new-password">
                        </div>

                        <div class="form-group">
                            <label for="adminFullName">To'liq ism</label>
                            <input type="text" id="adminFullName" name="adminFullName" placeholder="To'liq ism kiriting"
                                autocomplete="name">
                        </div>

                        <div class="form-group">
                            <label for="adminRole">Rol *</label>
                            <select id="adminRole" name="adminRole" required
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit;">
                                <option value="user">User</option>
                                <option value="admin" selected>Admin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="adminOrganization">Tashkilot</label>
                            <select id="adminOrganization" name="adminOrganization"
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit;">
                                <option value="">Tashkilotni tanlang (ixtiyoriy)</option>
                            </select>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn-cancel" id="cancelAddAdminBtn">Bekor qilish</button>
                            <button type="submit" class="btn-save">Saqlash</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create/Edit Department Modal -->
        <div id="departmentModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #ffffff;">
                    <div class="header-left">
                        <h1 id="departmentModalTitle"
                            style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #111827;">Bo'lim yaratish
                        </h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Bo'limlar /
                            Bo'lim yaratish</p>
                    </div>
                    <span class="modal-close" id="closeDeptModal"
                        style="cursor: pointer; font-size: 24px; color: #6b7280; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#111827';"
                        onmouseout="this.style.background=''; this.style.color='#6b7280';">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="departmentForm">
                        <input type="hidden" id="deptId" name="deptId">

                        <div class="form-group">
                            <label for="deptOrganization">Tashkilot *</label>
                            <select id="deptOrganization" name="deptOrganization" required
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit;">
                                <option value="">Tashkilotni tanlang</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="deptName">Bo'lim nomi *</label>
                            <input type="text" id="deptName" name="deptName" required
                                placeholder="Bo'lim nomini kiriting" autocomplete="organization">
                        </div>

                        <div class="form-group">
                            <label for="deptDescription">Tavsif</label>
                            <textarea id="deptDescription" name="deptDescription" rows="4"
                                placeholder="Bo'lim haqida ma'lumot"
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn-cancel" id="cancelDeptBtn">Bekor qilish</button>
                            <button type="submit" class="btn-save">Saqlash</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Employees Management Section -->
        <div id="employeesSection" class="content-section" style="display: none;">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: #111827; letter-spacing: -0.3px;">Xodimlar</h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Admin / Xodimlar</p>
                    </div>
                    <div class="header-right">
                        <div class="sidebar-user-profile" onclick="openSuperAdminInfoModal()"
                            style="margin: 0; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); height: 40px; box-sizing: border-box; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.15)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';">
                            <div class="sidebar-user-icon"
                                style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent;">
                                <img src="/uploads/Icoonlar/galochka-3d-icon-png-download-11169918.webp" alt="User Icon"
                                    style="width: 22px; height: 22px; object-fit: contain; background: transparent;">
                            </div>
                            <div class="sidebar-user-info" style="flex: 1; min-width: 0;">
                                <div class="sidebar-user-name" id="empDashboardUserName"
                                    style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px;">
                                    A.Turdiyev</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="employees-header">
                    <div class="employees-title">Xodimlar</div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="time-filter">
                            <select class="filter-select" id="empPeriodSelect">
                                <option value="all" selected>Hammasi</option>
                            </select>
                        </div>
                        <button class="export-btn" id="empExportBtn" title="Export to Excel"><span>ðŸ“¥</span> Excel'ga eksport qilish</button>
                        <div class="search-container" style="width: 180px;">
                            <input type="text" class="search-input" id="empSearchInput" placeholder="Qidirish..." autocomplete="off">
                            <span class="search-icon">âŒ•</span>
                        </div>
                        <button id="createEmployeeBtn" class="btn-create-org"><span>âž•</span> Yangi xodim</button>
                    </div>
                </div>

                <div class="employees-table-container">
                    <table class="emp-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>ISM</th>
                                <th style="width: 150px;">BO'LIM</th>
                                <th style="width: 150px;">LAVOZIM</th>
                                <th style="width: 130px;">TELEFON</th>
                                <th style="width: 180px;">EMAIL</th>
                                <th style="width: 110px;">QO'SHILGAN SANA</th>
                                <th style="width: 100px;">STATUS</th>
                                <th class="admin-only" style="width: 120px;">AMALLAR</th>
                            </tr>
                        </thead>
                        <tbody id="employeesManagementList">
                            <tr>
                                <td colspan="9" class="empty-row">Xodimlar mavjud emas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Positions Management Section -->
        <div id="positionsSection" class="content-section" style="display: none;">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: #111827; letter-spacing: -0.3px;">Lavozimlar</h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Admin / Lavozimlar</p>
                    </div>
                    <div class="header-right">
                        <div style="display: flex; align-items: center; gap: 8px; margin-right: 8px;">
                            <div style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                                onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                                onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                    style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                    <polyline points="22,6 12,13 2,6" />
                                </svg>
                            </div>
                            <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-sizing: border-box;"
                                onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                                onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                    style="width: 20px; height: 20px; fill: none; stroke: #6b7280; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                                </svg>
                                <div
                                    style="position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; border: 2px solid #ffffff;">
                                </div>
                            </div>
                        </div>
                        <div class="language-selector"
                            style="display: flex; align-items: center; gap: 8px; margin-right: 8px; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s; height: 40px; box-sizing: border-box;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 1px 3px rgba(16, 185, 129, 0.1)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 18px; height: 18px; fill: #6b7280;">
                                <path
                                    d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                            </svg>
                            <span id="currentLanguagePos"
                                style="font-size: 0.875rem; font-weight: 500; color: #6b7280;">O'z</span>
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"
                                style="width: 16px; height: 16px; fill: #6b7280; margin-left: 4px;">
                                <path d="M7 10l5 5 5-5z" />
                            </svg>
                        </div>
                        <div class="language-dropdown" id="languageDropdownPos"
                            style="display: none; position: absolute; top: 60px; right: 24px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 1000; min-width: 120px; padding: 8px 0;">
                            <div class="language-option" onclick="changeLanguage('uz', 'currentLanguagePos', 'languageDropdownPos')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">O'z</span>
                            </div>
                            <div class="language-option" onclick="changeLanguage('ru', 'currentLanguagePos', 'languageDropdownPos')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Ru</span>
                            </div>
                            <div class="language-option" onclick="changeLanguage('en', 'currentLanguagePos', 'languageDropdownPos')"
                                style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border-top: 1px solid #e5e7eb;"
                                onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">Eng</span>
                            </div>
                        </div>
                        <div class="sidebar-user-profile" onclick="openSuperAdminInfoModal()"
                            style="margin: 0; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); height: 40px; box-sizing: border-box; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.15)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';">
                            <div class="sidebar-user-icon"
                                style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent;">
                                <img src="/uploads/Icoonlar/galochka-3d-icon-png-download-11169918.webp" alt="User Icon"
                                    style="width: 22px; height: 22px; object-fit: contain; background: transparent;">
                            </div>
                            <div class="sidebar-user-info" style="flex: 1; min-width: 0;">
                                <div class="sidebar-user-name" id="posDashboardUserName"
                                    style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px;">
                                    A.Turdiyev</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="employees-header">
                    <div class="employees-title">Lavozimlar</div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div class="time-filter">
                            <select class="filter-select" id="posPeriodSelect">
                                <option value="all" selected>Hammasi</option>
                            </select>
                        </div>
                        <button class="export-btn" id="posExportBtn" title="Export to Excel"><span>ðŸ“¥</span> Excel'ga eksport qilish</button>
                        <div class="search-container" style="width: 180px;">
                            <input type="text" class="search-input" id="posSearchInput" placeholder="Qidirish..." autocomplete="off">
                            <span class="search-icon">âŒ•</span>
                        </div>
                        <button id="createPositionBtn" class="btn-create-org"><span>âž•</span> Yangi lavozim</button>
                    </div>
                </div>

                <div class="employees-table-container" id="positionsList">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">â„–</th>
                                <th>Lavozim nomi</th>
                                <th>Tavsif</th>
                                <th class="admin-only" style="width: 120px;">Amallar</th>
                            </tr>
                        </thead>
                        <tbody id="positionsTableBody">
                            <tr>
                                <td colspan="4" class="empty-row">Lavozimlar yig'ilmoqda...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Position Modal -->
        <div id="positionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #ffffff;">
                    <div class="header-left">
                        <h1 id="positionModalTitle"
                            style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #111827;">Lavozim yaratish
                        </h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Lavozimlar /
                            Lavozim yaratish</p>
                    </div>
                    <span class="modal-close" id="closePositionModal"
                        style="cursor: pointer; font-size: 24px; color: #6b7280; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#111827';"
                        onmouseout="this.style.background=''; this.style.color='#6b7280';">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="positionForm">
                        <input type="hidden" id="positionId" name="positionId">

                        <div class="form-group">
                            <label for="positionName">Lavozim nomi *</label>
                            <input type="text" id="positionName" name="positionName" required
                                placeholder="Lavozim nomini kiriting" autocomplete="organization-title">
                        </div>

                        <div class="form-group">
                            <label for="positionDescription">Tavsif</label>
                            <textarea id="positionDescription" name="positionDescription" rows="4"
                                placeholder="Lavozim haqida ma'lumot"
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn-cancel" id="cancelPositionBtn">Bekor qilish</button>
                            <button type="submit" class="btn-save">Saqlash</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="content-section" style="display: none;">
            <div class="container">
                <div class="header">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 24px; font-weight: 700; color: #111827; letter-spacing: -0.3px;">Sozlamalar</h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Admin / Sozlamalar</p>
                    </div>
                    <div class="header-right">
                        <div class="sidebar-user-profile" onclick="openSuperAdminInfoModal()"
                            style="margin: 0; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); height: 40px; box-sizing: border-box; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 2px 6px rgba(16, 185, 129, 0.15)';"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)';">
                            <div class="sidebar-user-icon"
                                style="width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: transparent;">
                                <img src="/uploads/Icoonlar/galochka-3d-icon-png-download-11169918.webp" alt="User Icon"
                                    style="width: 22px; height: 22px; object-fit: contain; background: transparent;">
                            </div>
                            <div class="sidebar-user-info" style="flex: 1; min-width: 0;">
                                <div class="sidebar-user-name" id="settingsDashboardUserName"
                                    style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px;">
                                    A.Turdiyev</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="employees-header">
                    <div class="employees-title">Sozlamalar</div>
                </div>

                <div class="employees-table-container" style="overflow: visible;">
                    <div class="org-list-container" style="padding: 24px; max-width: 1200px; margin: 0 auto;">
                        <div style="width: 100%; max-width: 1200px; margin: 0 auto;">
                            <div
                                style="background: #ffffff; border-radius: 12px; padding: 28px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); width: 100%; box-sizing: border-box;">
                                <h2
                                    style="margin: 0 0 20px 0; font-size: 1.5rem; font-weight: 700; color: #111827; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                                    Super Admin ma'lumotlari</h2>

                                <form id="superAdminForm"
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <!-- Rasm yuklash - to'liq kenglikda -->
                                    <div class="form-group"
                                        style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 10px; padding-bottom: 16px; border-bottom: 1px solid #f3f4f6;">
                                        <label style="font-size: 0.875rem; font-weight: 600; color: #374151;">Profil
                                            rasmi</label>
                                        <div style="display: flex; align-items: center; gap: 16px;">
                                            <div id="superAdminPhotoPreview"
                                                style="width: 100px; height: 100px; border-radius: 10px; border: 2px solid #e5e7eb; display: flex; align-items: center; justify-content: center; background: #f9fafb; overflow: hidden; flex-shrink: 0;">
                                                <img id="superAdminPhotoImg" src="" alt="Profil rasmi"
                                                    style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                                <span style="color: #9ca3af; font-size: 0.75rem;">Rasm yo'q</span>
                                            </div>
                                            <div style="flex: 1;">
                                                <input type="file" id="superAdminPhoto" name="photo"
                                                    accept="image/jpeg,image/png,image/jpg" style="display: none;"
                                                    onchange="handleSuperAdminPhotoChange(event)">
                                                <button type="button"
                                                    onclick="document.getElementById('superAdminPhoto').click()"
                                                    style="padding: 10px 20px; background: #10b981; color: #ffffff; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                                    onmouseover="this.style.background='#059669';"
                                                    onmouseout="this.style.background='#10b981';">
                                                    Rasm tanlash
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chap ustun -->
                                    <div style="display: flex; flex-direction: column; gap: 16px;">
                                        <div class="form-group">
                                            <label for="superAdminFirstName"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Ism
                                                *</label>
                                            <input type="text" id="superAdminFirstName" name="firstName" required
                                                placeholder="Ismni kiriting"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>

                                        <div class="form-group">
                                            <label for="superAdminUsername"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Login
                                                *</label>
                                            <input type="text" id="superAdminUsername" name="username" required
                                                placeholder="Login kiriting"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>

                                        <div class="form-group">
                                            <label for="superAdminBirthYear"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Tug'ilgan
                                                yil</label>
                                            <input type="number" id="superAdminBirthYear" name="birthYear"
                                                placeholder="Yil" min="1900" max="2010"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>

                                        <div class="form-group">
                                            <label for="superAdminEmail"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Email</label>
                                            <input type="email" id="superAdminEmail" name="email"
                                                placeholder="Email kiriting"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>
                                    </div>

                                    <!-- O'ng ustun -->
                                    <div style="display: flex; flex-direction: column; gap: 16px;">
                                        <div class="form-group">
                                            <label for="superAdminLastName"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Familiya
                                                *</label>
                                            <input type="text" id="superAdminLastName" name="lastName" required
                                                placeholder="Familiyani kiriting"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>

                                        <div class="form-group">
                                            <label for="superAdminPassword"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Yangi
                                                parol</label>
                                            <input type="password" id="superAdminPassword" name="password"
                                                placeholder="Parolni kiriting (bo'sh qoldirish mumkin)"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>

                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                            <div class="form-group">
                                                <label for="superAdminBirthMonth"
                                                    style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Oy</label>
                                                <select id="superAdminBirthMonth" name="birthMonth"
                                                    style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; background: #ffffff; box-sizing: border-box;"
                                                    onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                    onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                                    <option value="">Oy tanlang</option>
                                                    <option value="1">Yanvar</option>
                                                    <option value="2">Fevral</option>
                                                    <option value="3">Mart</option>
                                                    <option value="4">Aprel</option>
                                                    <option value="5">May</option>
                                                    <option value="6">Iyun</option>
                                                    <option value="7">Iyul</option>
                                                    <option value="8">Avgust</option>
                                                    <option value="9">Sentabr</option>
                                                    <option value="10">Oktabr</option>
                                                    <option value="11">Noyabr</option>
                                                    <option value="12">Dekabr</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="superAdminBirthDay"
                                                    style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Kun</label>
                                                <input type="number" id="superAdminBirthDay" name="birthDay"
                                                    placeholder="Kun" min="1" max="31"
                                                    style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                    onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                    onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="superAdminPhone"
                                                style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Telefon
                                                raqami</label>
                                            <input type="tel" id="superAdminPhone" name="phone"
                                                placeholder="Telefon raqamini kiriting"
                                                style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; box-sizing: border-box;"
                                                onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                                onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';">
                                        </div>
                                    </div>

                                    <!-- Manzil - to'liq kenglikda -->
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="superAdminAddress"
                                            style="font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block;">Manzil</label>
                                        <textarea id="superAdminAddress" name="address" rows="3"
                                            placeholder="Manzilni kiriting"
                                            style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; resize: vertical; box-sizing: border-box; font-family: inherit;"
                                            onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)';"
                                            onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';"></textarea>
                                    </div>

                                    <!-- Saqlash tugmasi -->
                                    <div
                                        style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 4px; padding-top: 18px; border-top: 1px solid #f3f4f6;">
                                        <button type="button" onclick="resetSuperAdminForm()"
                                            style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#e5e7eb';"
                                            onmouseout="this.style.background='#f3f4f6';">
                                            Tozalash
                                        </button>
                                        <button type="submit"
                                            style="padding: 10px 20px; background: #10b981; color: #ffffff; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#059669';"
                                            onmouseout="this.style.background='#10b981';">
                                            Saqlash
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Super Admin Info Modal (Profil ma'lumotlari) -->
        <div id="superAdminInfoModal" class="modal profile-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #e2e8f0; background: #fff;">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: #0f172a;">Profil ma'lumotlari</h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #64748b;">Shaxsiy ma'lumotlar va sozlamalar</p>
                    </div>
                    <span class="modal-close" id="closeSuperAdminInfoModal"
                        style="cursor: pointer; font-size: 22px; color: #64748b; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f1f5f9'; this.style.color='#0f172a';"
                        onmouseout="this.style.background=''; this.style.color='#64748b';">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="superAdminInfoContent">
                        <div id="superAdminInfoLoading" style="text-align: center; padding: 48px; color: #64748b; font-size: 0.9rem;">Ma'lumotlar yuklanmoqda...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div id="editEmployeeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #ffffff;">
                    <div class="header-left">
                        <h1 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #111827;">Xodimni tahrirlash
                        </h1>
                        <p style="margin: 2px 0 0 0; font-size: 0.75rem; color: #6b7280; font-weight: 400;">Xodimlar /
                            Xodimni tahrirlash</p>
                    </div>
                    <span class="modal-close" id="closeEditModal"
                        style="cursor: pointer; font-size: 24px; color: #6b7280; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;"
                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#111827';"
                        onmouseout="this.style.background=''; this.style.color='#6b7280';">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editEmployeeForm" autocomplete="off">
                        <input type="hidden" id="editUserId" name="userId">

                        <div class="form-group">
                            <label for="photoInput">Rasm</label>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div id="currentPhotoPreview"
                                    style="width: 80px; height: 80px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <span id="photoPlaceholder">Rasm yo'q</span>
                                </div>
                                <div style="flex: 1;">
                                    <input type="file" id="photoInput" accept="image/*" style="margin-bottom: 8px;"
                                        autocomplete="off">
                                    <div style="font-size: 0.85rem; color: #6b7280;">Rasm faylini tanlang (JPG, PNG)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editFullName">To'liq ism</label>
                            <input type="text" id="editFullName" name="fullName" placeholder="To'liq ismni kiriting"
                                autocomplete="name">
                        </div>

                        <div class="form-group">
                            <label for="editDepartment">Bo'lim</label>
                            <select id="editDepartment" name="department"
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit;">
                                <option value="">Bo'limni tanlang</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editPosition">Lavozim</label>
                            <select id="editPosition" name="position"
                                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; font-family: inherit;">
                                <option value="">Lavozimni tanlang</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editPhone">Telefon</label>
                            <input type="tel" id="editPhone" name="phone" placeholder="Telefon raqamini kiriting"
                                autocomplete="tel">
                        </div>

                        <div class="form-group">
                            <label for="editEmail">Email</label>
                            <input type="email" id="editEmail" name="email" placeholder="Email manzilini kiriting"
                                autocomplete="email">
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn-cancel" id="cancelEditBtn">Cancel</button>
                            <button type="submit" class="btn-save">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        

        <script>
            let eventCount = 0;
            let eventSource = null;
            let currentLang = localStorage.getItem('language') || 'uz';

            // Language selector functionality
            const languageSelector = document.querySelector('.language-selector');
            const languageDropdown = document.getElementById('languageDropdown');
            const currentLanguageSpan = document.getElementById('currentLanguage');

            if (languageSelector) {
                languageSelector.addEventListener('click', function (e) {
                    e.stopPropagation();
                    if (languageDropdown) {
                        languageDropdown.style.display = languageDropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (languageDropdown && languageSelector && !languageSelector.contains(e.target) && !languageDropdown.contains(e.target)) {
                    languageDropdown.style.display = 'none';
                }
            });

            // Change language function
            window.changeLanguage = function (lang) {
                currentLang = lang;
                localStorage.setItem('language', lang);

                const langMap = {
                    'uz': 'O\'z',
                    'ru': 'Ru',
                    'en': 'Eng'
                };

                // Update current language span
                if (currentLanguageSpan) {
                    currentLanguageSpan.textContent = langMap[lang] || 'O\'z';
                }

                // Close dropdown
                if (languageDropdown) {
                    languageDropdown.style.display = 'none';
                }

                // Here you can add language change logic
            };

            // Set initial language
            if (currentLanguageSpan) {
                const langMap = {
                    'uz': 'O\'z',
                    'ru': 'Ru',
                    'en': 'Eng'
                };
                currentLanguageSpan.textContent = langMap[currentLang] || 'O\'z';
            }

            // Organizations section language selector
            const orgLanguageSelector = document.querySelector('#organizationsSection .language-selector');
            const orgLanguageDropdown = document.getElementById('orgLanguageDropdown');
            const orgCurrentLanguageSpan = document.getElementById('orgCurrentLanguage');

            if (orgLanguageSelector) {
                orgLanguageSelector.addEventListener('click', function (e) {
                    e.stopPropagation();
                    if (orgLanguageDropdown) {
                        orgLanguageDropdown.style.display = orgLanguageDropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            // Close org dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (orgLanguageDropdown && orgLanguageSelector && !orgLanguageSelector.contains(e.target) && !orgLanguageDropdown.contains(e.target)) {
                    orgLanguageDropdown.style.display = 'none';
                }
            });

            // Set initial language for org section
            if (orgCurrentLanguageSpan) {
                const langMap = {
                    'uz': 'O\'z',
                    'ru': 'Ru',
                    'en': 'Eng'
                };
                orgCurrentLanguageSpan.textContent = langMap[currentLang] || 'O\'z';
            }

            // Positions section language selector
            const posLanguageSelector = document.querySelector('#positionsSection .language-selector');
            const posLanguageDropdown = document.getElementById('languageDropdownPos');
            const posCurrentLanguageSpan = document.getElementById('currentLanguagePos');

            if (posLanguageSelector) {
                posLanguageSelector.addEventListener('click', function (e) {
                    e.stopPropagation();
                    if (posLanguageDropdown) {
                        posLanguageDropdown.style.display = posLanguageDropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            // Close pos dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (posLanguageDropdown && posLanguageSelector && !posLanguageSelector.contains(e.target) && !posLanguageDropdown.contains(e.target)) {
                    posLanguageDropdown.style.display = 'none';
                }
            });

            // Set initial language for pos section
            if (posCurrentLanguageSpan) {
                const langMap = {
                    'uz': 'O\'z',
                    'ru': 'Ru',
                    'en': 'Eng'
                };
                posCurrentLanguageSpan.textContent = langMap[currentLang] || 'O\'z';
            }

            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const eventCountEl = document.getElementById('eventCount');

            const lastAvatarEl = document.getElementById('lastAvatar');
            const lastNameEl = document.getElementById('lastName');
            const lastUserIdEl = document.getElementById('lastUserId');
            const lastTimeEl = document.getElementById('lastTime');
            const lastLateEl = document.getElementById('lastLate');

            // Check if elements exist before using them (silently, no warning needed)

            const employeesBody = document.getElementById('employeesBody');
            const usersTotalEl = document.getElementById('usersTotal');
            const usersLateEl = document.getElementById('usersLate');

            const users = new Map(); // key: userId or CardName, value: stats
            let totalEmployeesCount = 0; // jami xodimlar soni (bazadan)
            let currentPeriod = 'daily'; // daily, weekly, yearly
            let searchQuery = ''; // search filter
            let statusFilter = 'all'; // all, ontime, late, absent
            let statisticsPeriod = 'daily'; // daily, weekly, monthly, yearly
            let departmentPeriod = 'daily'; // daily, weekly, monthly, yearly

            // Department statistics - group users by position/department
            function getDepartmentStats() {
                const allUsers = Array.from(users.values());
                const filteredUsers = filterUsersByStatisticsPeriod(allUsers, 'monthly');

                // Group users by department (not position!)
                const deptMap = new Map();

                filteredUsers.forEach(user => {
                    // Use department_name from database (NOT position, as position is lavozim, not bo'lim)
                    const dept = user.department_name || 'Boshqa';
                    if (!deptMap.has(dept)) {
                        deptMap.set(dept, []);
                    }
                    deptMap.get(dept).push(user);
                });

                // Calculate monthly average KPI for each department
                const departments = [];
                deptMap.forEach((deptUsers, deptName) => {
                    let totalMonthlyKPI = 0;
                    let validUsers = 0;

                    // Har bir xodimning oylik KPI sini hisoblaymiz va qo'shamiz
                    deptUsers.forEach(user => {
                        const monthlyKPI = calculateMonthlyKPI(user);
                        if (monthlyKPI >= 0) {
                            totalMonthlyKPI += monthlyKPI;
                            validUsers++;
                        }
                    });

                    // Oylik o'rtacha KPI = barcha xodimlarning oylik KPI yig'indisi / xodimlar soni
                    const avgMonthlyKPI = validUsers > 0 ? Math.round(totalMonthlyKPI / validUsers) : 0;

                    departments.push({
                        name: deptName,
                        employeeCount: deptUsers.length,
                        avgKPI: avgMonthlyKPI
                    });
                });

                // Sort by employee count (descending)
                departments.sort((a, b) => b.employeeCount - a.employeeCount);

                return departments;
            }

            function renderDepartmentChart() {
                const container = document.getElementById('departmentChartContainer');
                if (!container) return;

                const departments = getDepartmentStats();

                if (departments.length === 0) {
                    container.innerHTML = '<div style="color: #6b7280; text-align: center; font-size: 0.875rem;">Ma\'lumotlar yo\'q</div>';
                    return;
                }

                // Find max employee count for scaling
                const maxCount = Math.max(...departments.map(d => d.employeeCount), 1);

                let html = '';
                departments.forEach(dept => {
                    const percentage = maxCount > 0 ? Math.round((dept.employeeCount / maxCount) * 100) : 0;

                    html += `
                <div class="bar-chart-item">
                    <div class="bar-chart-label">${dept.name}</div>
                    <div class="bar-chart-bar-container">
                        <div class="bar-chart-bar" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="bar-chart-value">${dept.avgKPI}%</div>
                </div>
            `;
                });

                container.innerHTML = html;
            }

            function updateStatus(connected) {
                if (!statusDot || !statusText) return;
                if (connected) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Ulangan';
                } else {
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Uzilgan';
                }
            }

            function extractField(data, path) {
                if (!data || typeof data !== 'object') return '-';
                const keys = path.split('.');
                let value = data;
                for (const key of keys) {
                    if (value && typeof value === 'object' && key in value) {
                        value = value[key];
                    } else {
                        return '-';
                    }
                }
                return value !== null && value !== undefined ? String(value) : '-';
            }

            function computeUserKey(data) {
                const userId = extractField(data, 'UserID') || extractField(data, 'userId');
                const cardName = extractField(data, 'CardName') || extractField(data, 'cardName');
                if (userId && userId !== '-') return `id:${userId}`;
                if (cardName && cardName !== '-') return `name:${cardName}`;
                return null;
            }

            function computeProductivity(user) {
                const et = user.excuseType || (user.isExcused === true ? 'excused' : user.isExcused === false ? 'not_excused' : null);
                if (user.isAbsent || user.minutesLateToday > 0) {
                    if (et === 'excused' || et === 'on_duty') {
                        return {
                            percent: 100,
                            label: et === 'on_duty' ? 'Safarda' : 'Sababli',
                            badgeClass: et === 'on_duty' ? 'badge-safarda' : 'badge-ontime',
                            kpiClass: 'kpi-high'
                        };
                    }
                    if (et === 'not_excused') {
                        return {
                            percent: 0,
                            label: 'Sababsiz',
                            badgeClass: 'badge-absent',
                            kpiClass: 'kpi-low'
                        };
                    }
                    if (user.isAbsent) {
                        return {
                            percent: 0,
                            label: 'Kelmagan',
                            badgeClass: 'badge-absent',
                            kpiClass: 'kpi-low'
                        };
                    }
                }

                let arrivalKPI = 0; // Kelish KPI (9:00-18:00 = 100%)
                let departureKPI = 0; // Ketish KPI (18:00-23:59 = 30%)
                let totalKPI = 0;

                // Kelish KPI hisoblash (9:00 dan 18:00 gacha = 100%)
                if (user.lastArrivalTime) {
                    const arrivalTime = new Date(user.lastArrivalTime);
                    const today = new Date(arrivalTime);
                    today.setHours(0, 0, 0, 0);

                    // 9:00 va 18:00 chegaralari
                    const workStart = new Date(today);
                    workStart.setHours(9, 0, 0, 0);
                    const workEnd = new Date(today);
                    workEnd.setHours(18, 0, 0, 0);

                    // Agar 9:00 dan 18:00 gacha kelgan bo'lsa = 100%
                    if (arrivalTime >= workStart && arrivalTime <= workEnd) {
                        arrivalKPI = 100;
                    } else if (arrivalTime < workStart) {
                        // 9:00 dan oldin kelgan = 100%
                        arrivalKPI = 100;
                    } else {
                        // 18:00 dan keyin kelgan = 0% (kelish KPI yo'q)
                        arrivalKPI = 0;
                    }
                }

                // Ketish KPI hisoblash (18:00 dan 23:59 gacha = 30%)
                if (user.lastDepartureTime) {
                    const departureTime = new Date(user.lastDepartureTime);
                    const today = new Date(departureTime);
                    today.setHours(0, 0, 0, 0);

                    // 18:00 va 23:59 chegaralari
                    const departureStart = new Date(today);
                    departureStart.setHours(18, 0, 0, 0);
                    const departureEnd = new Date(today);
                    departureEnd.setHours(23, 59, 59, 999);

                    // Agar 18:00 dan 23:59 gacha ketgan bo'lsa = 30%
                    if (departureTime >= departureStart && departureTime <= departureEnd) {
                        departureKPI = 30;
                    }
                }

                // Umumiy KPI = Kelish KPI + Ketish KPI
                totalKPI = arrivalKPI + departureKPI;
                if (totalKPI > 130) totalKPI = 130; // Maksimal 130%

                // Label va rang belgilash
                let label, badgeClass, kpiClass;
                if (totalKPI >= 100) {
                    label = 'High';
                    badgeClass = 'badge-ontime';
                    kpiClass = 'kpi-high';
                } else if (totalKPI >= 50) {
                    label = 'Medium';
                    badgeClass = 'badge-neutral';
                    kpiClass = 'kpi-medium';
                } else {
                    label = 'Low';
                    badgeClass = 'badge-late';
                    kpiClass = 'kpi-low';
                }

                return { label, badgeClass, percent: totalKPI, kpiClass, arrivalKPI, departureKPI };
            }

            // Oylik KPI o'rtachasini yuklash
            let monthlyKPIMap = new Map(); // userId -> averageKPI
            
            async function loadMonthlyKPIs() {
                try {
                    const now = new Date();
                    const month = now.getMonth() + 1;
                    const year = now.getFullYear();
                    
                    const response = await fetch(`/api/employees/monthly-kpi?month=${month}&year=${year}`, {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.kpis) {
                            monthlyKPIMap.clear();
                            result.kpis.forEach(kpi => {
                                monthlyKPIMap.set(kpi.userId, kpi.averageKPI);
                            });
                            // Re-render active employees cards with updated KPI
                            const allUsers = Array.from(users.values());
                            renderActiveEmployeesCards(allUsers);
                        }
                    }
                } catch (err) {
                    console.error('Error loading monthly KPIs:', err);
                }
            }

            // Oylik KPI hisoblash (cache'dan olish)
            function calculateMonthlyKPI(user) {
                if (user.userId && monthlyKPIMap.has(user.userId)) {
                    return monthlyKPIMap.get(user.userId);
                }
                // Agar oylik KPI topilmasa, bugungi KPI ni qaytar
                const prod = computeProductivity(user);
                return prod.percent;
            }

            function filterUsersByPeriod(usersArray, period) {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const todayEnd = new Date(todayStart);
                todayEnd.setDate(todayEnd.getDate() + 1);

                return usersArray.filter(user => {
                    const timeToCheck = user.lastArrivalTime || user.lastSeenAt;
                    if (!timeToCheck) return false;

                    const userDate = new Date(timeToCheck);

                    if (period === 'daily') {
                        return userDate >= todayStart && userDate < todayEnd;
                    } else if (period === 'weekly') {
                        const weekAgo = new Date(todayStart);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return userDate >= weekAgo && userDate < todayEnd;
                    } else if (period === 'yearly') {
                        const yearStart = new Date(now.getFullYear(), 0, 1);
                        return userDate >= yearStart && userDate < todayEnd;
                    }
                    return true;
                });
            }

            function filterUsersByStatisticsPeriod(usersArray, period) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                return usersArray.filter(user => {
                    // Use lastArrivalTime if available, otherwise use lastSeenAt
                    const timeToCheck = user.lastArrivalTime || user.lastSeenAt;
                    if (!timeToCheck) return false; // Skip users with no time data

                    const userDate = new Date(timeToCheck);

                    if (period === 'daily') {
                        return userDate >= today;
                    } else if (period === 'weekly') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return userDate >= weekAgo;
                    } else if (period === 'monthly') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return userDate >= monthAgo;
                    } else if (period === 'yearly') {
                        const yearAgo = new Date(today);
                        yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                        return userDate >= yearAgo;
                    }
                    return true;
                });
            }

            function updateCurrentSummary(event) {
                if (!event || event.code !== 'AccessControl') return;
                // Skip if summary elements don't exist (user doesn't want last access info)
                if (!lastAvatarEl || !lastNameEl) return;

                const data = event.data || {};
                const userId = extractField(data, 'UserID') || extractField(data, 'userId') || '-';
                const cardName = extractField(data, 'CardName') || extractField(data, 'cardName') || 'Unknown';
                const timeIso = event.receivedAt || new Date().toISOString();
                const date = new Date(timeIso);

                // Avatar initials
                const initials = cardName
                    .split(' ')
                    .filter(Boolean)
                    .map(p => p[0])
                    .join('')
                    .substring(0, 2)
                    .toUpperCase() || 'U';

                if (lastAvatarEl) lastAvatarEl.textContent = initials;
                if (lastNameEl) lastNameEl.textContent = cardName;
                if (lastUserIdEl) lastUserIdEl.textContent = userId !== '-' ? `User ID: ${userId}` : '';
                if (lastTimeEl) lastTimeEl.textContent = date.toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // Lateness vs onTimeThreshold
                if (lastLateEl) {
                    const today = new Date(date);
                    today.setHours(0, 0, 0, 0);
                    const onTimeDeadline = new Date(today);
                    onTimeDeadline.setHours(timeSettings.onTimeThreshold.hours, timeSettings.onTimeThreshold.minutes, 0, 0);

                    lastLateEl.classList.remove('ontime', 'late');
                    if (date <= onTimeDeadline) {
                        lastLateEl.textContent = 'Vaqtida';
                        lastLateEl.classList.add('ontime');
                    } else {
                        const diffMs = date.getTime() - onTimeDeadline.getTime();
                        const diffMin = Math.round(diffMs / 60000);
                        lastLateEl.textContent = `Kechikdi: ${diffMin} min`;
                        lastLateEl.classList.add('late');
                    }
                }
            }

            // Load employee data from API and merge with user data
            async function loadEmployeeData(userId) {
                // Skip invalid user IDs
                if (!userId || userId === '-' || userId === 'undefined' || userId === 'null' || userId === '') {
                    return;
                }

                // Use AbortController to silently handle errors
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                try {
                    const response = await fetch(`/api/employees/${userId}`, {
                        credentials: 'include',
                        signal: controller.signal
                    }).catch(err => {
                        // Silently ignore all fetch errors (network, abort, etc.)
                        return null;
                    });

                    clearTimeout(timeoutId);

                    if (!response) {
                        return; // Network error, silently ignore
                    }

                    // Only process if response is OK (200-299)
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.employee) {
                            const emp = result.employee;
                            // Find user by userId
                            for (const [key, user] of users.entries()) {
                                if (user.userId === userId || user.userId === emp.user_id) {
                                    // Merge employee data (preserve saved data)
                                    if (emp.full_name) user.name = emp.full_name;
                                    if (emp.position) user.position = emp.position;
                                    if (emp.organization) user.organization = emp.organization;
                                    if (emp.department_name) user.department_name = emp.department_name;
                                    if (emp.phone) user.phone = emp.phone;
                                    if (emp.email) user.email = emp.email;
                                    if (emp.photo_base64) {
                                        // Check if already has data: prefix
                                        if (emp.photo_base64.startsWith('data:')) {
                                            user.imageUrl = emp.photo_base64;
                                        } else {
                                            user.imageUrl = `data:image/jpeg;base64,${emp.photo_base64}`;
                                        }
                                    } else if (emp.photo_url) {
                                        user.imageUrl = emp.photo_url;
                                    }
                                    users.set(key, user);
                                    break;
                                }
                            }
                            // Re-render table after updating employee data
                            renderEmployeesTable();
                        }
                    }
                    // If response is not OK (404, 401, etc.), silently ignore
                } catch (err) {
                    // Silently ignore all errors (AbortError, network errors, etc.)
                    // No console logging to prevent 404 errors from showing
                }
            }

            // Load all employees data on page load
            async function loadAllEmployees() {
                try {
                    const response = await fetch('/api/employees', {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const result = await response.json();
                        totalEmployeesCount = (result.success && result.employees && Array.isArray(result.employees)) ? result.employees.length : 0;
                        if (result.success && result.employees && result.employees.length > 0) {
                            const employeeMap = new Map();
                            result.employees.forEach(emp => {
                                if (emp.user_id) employeeMap.set(emp.user_id, emp);
                            });
                            for (const [key, user] of users.entries()) {
                                const emp = employeeMap.get(user.userId);
                                if (emp) {
                                    if (emp.full_name) user.name = emp.full_name;
                                    if (emp.position) user.position = emp.position;
                                    if (emp.organization) user.organization = emp.organization;
                                    if (emp.department_name) user.department_name = emp.department_name;
                                    if (emp.phone) user.phone = emp.phone;
                                    if (emp.email) user.email = emp.email;
                                    if (emp.photo_base64) {
                                        user.imageUrl = emp.photo_base64.startsWith('data:') ? emp.photo_base64 : `data:image/jpeg;base64,${emp.photo_base64}`;
                                    } else if (emp.photo_url) user.imageUrl = emp.photo_url;
                                    users.set(key, user);
                                }
                            }
                            renderEmployeesTable();
                        } else {
                            renderEmployeesTable();
                        }
                        const allUsers = Array.from(users.values());
                        updateStatusCards(allUsers);
                    } else {
                        renderEmployeesTable();
                        updateStatusCards(Array.from(users.values()));
                    }
                } catch (err) {
                    console.error('Error loading all employees:', err);
                    renderEmployeesTable();
                    updateStatusCards(Array.from(users.values()));
                }
            }

            // Load today's attendance records to get is_excused status
            async function loadTodayAttendance() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const response = await fetch(`/api/attendance?date=${today}`, {
                        credentials: 'include'
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.records && result.records.length > 0) {
                            // Create a map of attendance data by userId
                            const attendanceMap = new Map();
                            result.records.forEach(record => {
                                if (record.user_id) {
                                    const et = record.excuse_type;
                                    let isExc = record.is_excused;
                                    if (et === 'excused' || et === 'on_duty') isExc = true;
                                    else if (et === 'not_excused') isExc = false;
                                    const arr = record.arrival_time;
                                    const dep = record.departure_time;
                                    const st = (record.status || '').toLowerCase();
                                    attendanceMap.set(record.user_id, {
                                        attendanceId: record.id,
                                        isExcused: isExc,
                                        excuseType: et || (isExc === true ? 'excused' : isExc === false ? 'not_excused' : null),
                                        lastArrivalTime: arr ? (typeof arr === 'string' ? arr : new Date(arr).toISOString()) : null,
                                        lastDepartureTime: dep ? (typeof dep === 'string' ? dep : new Date(dep).toISOString()) : null,
                                        minutesLateToday: record.minutes_late != null ? record.minutes_late : 0,
                                        isAbsent: st === 'absent'
                                    });
                                }
                            });

                            for (const [key, user] of users.entries()) {
                                const attendance = attendanceMap.get(user.userId);
                                if (attendance) {
                                    user.attendanceId = attendance.attendanceId;
                                    user.isExcused = attendance.isExcused;
                                    user.excuseType = attendance.excuseType;
                                    if (attendance.lastArrivalTime) user.lastArrivalTime = attendance.lastArrivalTime;
                                    if (attendance.lastDepartureTime) {
                                        user.lastDepartureTime = attendance.lastDepartureTime;
                                        user.hasDeparted = true;
                                    }
                                    if (attendance.minutesLateToday != null) user.minutesLateToday = attendance.minutesLateToday;
                                    if (attendance.isAbsent != null) user.isAbsent = attendance.isAbsent;
                                    users.set(key, user);
                                }
                            }
                            // Re-render table after updating attendance data
                            renderEmployeesTable();
                        }
                    }
                } catch (err) {
                    // Silently ignore errors
                }
            }

            function updateUsersFromEvent(event) {
                if (!event || event.code !== 'AccessControl') {
                    return;
                }

                // Deduplication check
                if (event.id && processedEventIds.has(event.id)) {
                    return;
                }
                if (event.id) processedEventIds.add(event.id);

                const data = event.data || {};
                const key = computeUserKey(data);
                if (!key) return;

                const nowIso = event.receivedAt || new Date().toISOString();
                const now = new Date(nowIso);

                const userId = extractField(data, 'UserID') || extractField(data, 'userId') || '-';
                const cardName = extractField(data, 'CardName') || extractField(data, 'cardName') || 'Unknown';
                const position = data.Position || data.JobTitle || data.Title || '-';

                // Vaqt hisoblash qoidalari (database sozlamalaridan):
                // - onTimeThreshold gacha = vaqtida kelganlar (minutesLate = 0)
                // - lateThreshold gacha = kech qolganlar (minutesLate > 0)
                // - absentThreshold dan keyin = kelmaganlar (isAbsent = true)
                // - departureStartTime dan keyin = ketganlar
                const today = new Date(now);
                today.setHours(0, 0, 0, 0);

                const workStart = new Date(today);
                workStart.setHours(timeSettings.onTimeThreshold.hours, timeSettings.onTimeThreshold.minutes, 0, 0);

                const onTimeDeadline = new Date(today);
                onTimeDeadline.setHours(timeSettings.onTimeThreshold.hours, timeSettings.onTimeThreshold.minutes, 0, 0);

                const lateDeadline = new Date(today);
                lateDeadline.setHours(timeSettings.lateThreshold.hours, timeSettings.lateThreshold.minutes, 59, 999);

                const absentDeadline = new Date(today);
                absentDeadline.setHours(timeSettings.absentThreshold.hours, timeSettings.absentThreshold.minutes, 0, 0);

                let minutesLate = 0;
                let isAbsent = false;

                if (now >= absentDeadline) {
                    // Absent threshold dan keyin = kelmaganlar
                    isAbsent = true;
                    minutesLate = 0;
                } else if (now > onTimeDeadline) {
                    // OnTime threshold dan keyin, late threshold gacha = kech qolganlar
                    minutesLate = Math.round((now.getTime() - workStart.getTime()) / 60000);
                    if (minutesLate < 0) minutesLate = 0;
                } else {
                    // OnTime threshold gacha = vaqtida kelganlar
                    minutesLate = 0;
                }

                // Get image URL from event data
                const imageUrl = data.FaceImageUrl || data.ImageUrl || data.imageUrl ||
                    data.SnapshotUrl || data.snapshotUrl || null;

                let user = users.get(key);
                if (!user) {
                    // Ketish vaqtini aniqlash: departureStartTime dan keyin scan qilsa, bu "ketdi" deb hisoblanadi
                    const departureTime = new Date(today);
                    departureTime.setHours(timeSettings.departureStartTime.hours, timeSettings.departureStartTime.minutes, 0, 0);

                    const hasDeparted = now > departureTime;

                    user = {
                        key,
                        userId,
                        name: cardName,
                        position,
                        imageUrl,
                        organization: null,
                        lastSeenAt: nowIso,
                        lastArrivalTime: hasDeparted ? null : nowIso, // null if departed, otherwise arrival time
                        lastDepartureTime: hasDeparted ? nowIso : null,
                        hasDeparted: hasDeparted,
                        minutesLateToday: minutesLate,
                        isAbsent: isAbsent,
                        onTimeCount: 0,
                        lateCount: 0,
                        totalVisits: 0
                    };
                    // Try to load saved employee data (silently, don't show errors)
                    // Only load if userId is valid and not a temporary ID
                    if (userId && userId !== '-' && userId !== 'undefined' && userId !== 'null' && !userId.toString().startsWith('TEMP_')) {
                        // Use setTimeout to avoid blocking and suppress console errors
                        setTimeout(() => {
                            loadEmployeeData(userId).catch(() => {
                                // Silently ignore all errors
                            });
                        }, 100);
                    }
                } else {
                    // Only update event-related fields, preserve saved employee data
                    user.userId = userId;
                    // Only update name/position if not saved in database
                    if (!user.name || user.name === 'Unknown' || user.name === cardName) {
                        user.name = cardName;
                    }
                    if (!user.position || user.position === '-') {
                        user.position = position;
                    }
                    // Only update image if not saved
                    if (!user.imageUrl && imageUrl) {
                        user.imageUrl = imageUrl;
                    }
                    user.lastSeenAt = nowIso;

                    const departureTime = new Date(today);
                    departureTime.setHours(timeSettings.departureStartTime.hours, timeSettings.departureStartTime.minutes, 0, 0);

                    if (now > departureTime) {
                        if (!user.lastDepartureTime) {
                            user.lastDepartureTime = nowIso;
                            user.hasDeparted = true;
                        }
                    } else {
                        if (!user.lastArrivalTime) {
                            user.lastArrivalTime = nowIso;
                            user.hasDeparted = false;
                            user.minutesLateToday = minutesLate;
                            user.isAbsent = isAbsent;
                        }
                    }
                }

                user.totalVisits += 1;
                if (isAbsent) {
                    // 12:00 dan keyin kelgan - absent
                    // Count'ni o'zgartirmaymiz, chunki absent alohida kategoriya
                } else if (minutesLate > 0) {
                    user.lateCount += 1;
                } else {
                    user.onTimeCount += 1;
                }

                users.set(key, user);
                renderEmployeesTable();

                // Force update statistics and charts
                const allUsers = Array.from(users.values());
                updateStatusCards(allUsers);
                renderDepartmentChart();
                renderActiveEmployeeCard('activeEmployeesList', allUsers);
            }

            function renderEmployeesTable() {
                if (!employeesBody) return;

                let allUsers = Array.from(users.values());

                // Filter by period
                allUsers = filterUsersByPeriod(allUsers, currentPeriod);

                // Filter by status (ontime, late, absent)
                if (statusFilter !== 'all') {
                    allUsers = allUsers.filter(user => {
                        if (statusFilter === 'ontime') {
                            return !user.isAbsent && user.minutesLateToday === 0;
                        } else if (statusFilter === 'late') {
                            return !user.isAbsent && user.minutesLateToday > 0;
                        } else if (statusFilter === 'absent') {
                            return user.isAbsent === true;
                        }
                        return true;
                    });
                }

                // Filter by search query
                if (searchQuery.trim()) {
                    const query = searchQuery.trim().toLowerCase();
                    allUsers = allUsers.filter(user => {
                        const userId = (user.userId || '').toLowerCase();
                        const name = (user.name || '').toLowerCase();
                        const position = (user.position || '').toLowerCase();
                        return userId.includes(query) || name.includes(query) || position.includes(query);
                    });
                }

                // Sort: absent first, then late users, then by lastSeenAt desc
                allUsers.sort((a, b) => {
                    const aAbsent = a.isAbsent === true;
                    const bAbsent = b.isAbsent === true;
                    if (aAbsent && !bAbsent) return -1;
                    if (!aAbsent && bAbsent) return 1;

                    const aLate = !aAbsent && a.minutesLateToday > 0;
                    const bLate = !bAbsent && b.minutesLateToday > 0;
                    if (aLate && !bLate) return -1;
                    if (!aLate && bLate) return 1;
                    if (aLate && bLate) {
                        return (b.minutesLateToday || 0) - (a.minutesLateToday || 0);
                    }
                    return new Date(b.lastSeenAt) - new Date(a.lastSeenAt);
                });

                employeesBody.innerHTML = '';

                if (allUsers.length === 0) {
                    const row = document.createElement('tr');
                    const message = searchQuery.trim()
                        ? 'Qidiruv bo\'yicha xodimlar topilmadi.'
                        : 'AccessControl hodisalarini kutish...';
                    row.innerHTML = `<td colspan="13" class="empty-row">${message}</td>`;
                    employeesBody.appendChild(row);
                } else {
                    let lateCount = 0;
                    let absentCount = 0;

                    for (const user of allUsers) {
                        if (user.isAbsent) {
                            absentCount++;
                        } else if (user.minutesLateToday > 0) {
                            lateCount++;
                        }

                        const prod = computeProductivity(user);
                        const isLate = !user.isAbsent && user.minutesLateToday > 0;
                        const isAbsent = user.isAbsent === true;

                        const row = document.createElement('tr');
                        if (isAbsent) {
                            row.classList.add('row-absent');
                        } else if (isLate) {
                            row.classList.add('row-late');
                        }

                        const initials = (user.name || 'U')
                            .split(' ')
                            .filter(Boolean)
                            .map(p => p[0])
                            .join('')
                            .substring(0, 2)
                            .toUpperCase() || 'U';

                        // Use lastArrivalTime if available, otherwise use lastSeenAt for display
                        const timeToDisplay = user.lastArrivalTime || user.lastSeenAt;

                        const arrivalDate = timeToDisplay
                            ? new Date(timeToDisplay).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            })
                            : '-';

                        const arrivalTime = timeToDisplay
                            ? new Date(timeToDisplay).toLocaleTimeString('en-US', {
                                hour12: false,
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            })
                            : '-';

                        let lateText, lateBadgeClass;
                        if (user.isAbsent) {
                            lateText = 'Kelmadi';
                            lateBadgeClass = 'badge-absent';
                        } else if (user.minutesLateToday > 0) {
                            lateText = 'Kechikmoqda';
                            lateBadgeClass = 'badge-late';
                        } else {
                            lateText = 'Ishda';
                            lateBadgeClass = 'badge-ontime';
                        }

                        // Photo cell
                        let photoCell;
                        if (user.imageUrl) {
                            photoCell = `<div style="position:relative;width:40px;height:40px;">
                        <img src="${user.imageUrl}" alt="${user.name}" class="user-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="user-photo-placeholder" style="display:none;">${initials}</div>
                    </div>`;
                        } else {
                            photoCell = `<div class="user-photo-placeholder">${initials}</div>`;
                        }

                        // Ketish vaqtini ko'rsatish
                    let departureTimeDisplay = '-';
                    if (user.lastDepartureTime) {
                        departureTimeDisplay = new Date(user.lastDepartureTime).toLocaleTimeString('en-US', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    }

                    // Status: kelgan = ptichka; kech/absent = Sababli / Sababsiz / Safarda tanlash
                    let excuseDropdown = '-';
                    const isAdmin = typeof isAdminUser === 'function' && isAdminUser();
                    const needsExcuse = user.isAbsent || user.minutesLateToday > 0;
                    const kelgan = !needsExcuse && user.lastArrivalTime;

                    if (kelgan) {
                        excuseDropdown = `<span class="status-checkmark" title="Kelgan">âœ“</span>`;
                    } else if (needsExcuse) {
                        const attendanceId = user.attendanceId || '';
                        const et = user.excuseType || (user.isExcused === true ? 'excused' : 'not_excused');
                        const excuseLabels = { excused: 'Sababli', not_excused: 'Sababsiz', on_duty: 'Safarda' };
                        const excuseText = excuseLabels[et] || 'Sababsiz';
                        const excuseBadgeClass = et === 'excused' ? 'badge-ontime' : et === 'on_duty' ? 'badge-safarda' : 'badge-absent';

                        if (isAdmin && attendanceId) {
                            excuseDropdown = `
                                <div class="excuse-badge-wrapper" style="position: relative; display: inline-block;">
                                    <span class="excuse-badge ${excuseBadgeClass}" 
                                          data-attendance-id="${attendanceId}" 
                                          data-user-id="${user.userId}"
                                          data-current="${et}"
                                          style="cursor: pointer; font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; display: inline-block;">
                                        ${excuseText}
                                    </span>
                                    <div class="excuse-dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1000; min-width: 120px; overflow: hidden;">
                                        <div class="excuse-option" data-value="excused" style="padding: 8px 12px; cursor: pointer; font-size: 0.75rem; transition: background 0.2s; border-bottom: 1px solid #e2e8f0; ${et === 'excused' ? 'background: #f0fdf4; color: #16a34a;' : ''}">Sababli</div>
                                        <div class="excuse-option" data-value="not_excused" style="padding: 8px 12px; cursor: pointer; font-size: 0.75rem; transition: background 0.2s; border-bottom: 1px solid #e2e8f0; ${et === 'not_excused' ? 'background: #fef2f2; color: #dc2626;' : ''}">Sababsiz</div>
                                        <div class="excuse-option" data-value="on_duty" style="padding: 8px 12px; cursor: pointer; font-size: 0.75rem; transition: background 0.2s; ${et === 'on_duty' ? 'background: #ecfdf5; color: #059669;' : ''}">Safarda</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            excuseDropdown = `<span class="badge ${excuseBadgeClass}" style="font-size: 0.75rem; padding: 4px 8px;">${excuseText}</span>`;
                        }
                    }

                    row.innerHTML = `
                    <td>${user.userId || '-'}</td>
                    <td>${photoCell}</td>
                    <td>
                        <div class="user-cell-main">
                            <div>
                                <div class="user-name">${user.name}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.department_name || '-'}</td>
                    <td>${user.position || user.organization || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${arrivalDate}</td>
                    <td>${arrivalTime}</td>
                    <td>${departureTimeDisplay}</td>
                    <td><span class="badge ${lateBadgeClass}">${lateText}</span></td>
                    <td>${excuseDropdown}</td>
                    <td><span class="kpi-value ${prod.kpiClass || ''}">${prod.percent}%</span></td>
                `;

                        employeesBody.appendChild(row);
                    }

                    if (usersLateEl) {
                        usersLateEl.textContent = String(allUsers.filter(u => u.minutesLateToday > 0).length);
                    }

                    if (typeof applyAdminOnlyVisibility === 'function') {
                        setTimeout(applyAdminOnlyVisibility, 50);
                    }

                    // Add event listeners for excuse badges
                    setTimeout(() => {
                        document.querySelectorAll('.excuse-badge').forEach(badge => {
                            const wrapper = badge.closest('.excuse-badge-wrapper');
                            const dropdown = wrapper ? wrapper.querySelector('.excuse-dropdown-menu') : null;
                            
                            if (!dropdown) return;
                            
                            // Badge ustiga bosilganda dropdown ochiladi/yopiladi
                            badge.addEventListener('click', function(e) {
                                e.stopPropagation();
                                // Boshqa dropdown'larni yopish
                                document.querySelectorAll('.excuse-dropdown-menu').forEach(menu => {
                                    if (menu !== dropdown) menu.style.display = 'none';
                                });
                                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                            });
                            
                            // Dropdown option'larni bosilganda
                            dropdown.querySelectorAll('.excuse-option').forEach(option => {
                                option.addEventListener('click', async function(e) {
                                    e.stopPropagation();
                                    const attendanceId = badge.getAttribute('data-attendance-id');
                                    const userId = badge.getAttribute('data-user-id');
                                    const value = this.getAttribute('data-value');
                                    
                                    if (!attendanceId || !userId) {
                                        console.error('Missing attendance ID or user ID');
                                        return;
                                    }
                                    if (!['excused', 'not_excused', 'on_duty'].includes(value)) return;

                                    try {
                                        const response = await fetch(`/api/attendance/${attendanceId}/excuse`, {
                                            method: 'PUT',
                                            headers: { 'Content-Type': 'application/json' },
                                            credentials: 'include',
                                            body: JSON.stringify({ excuse_type: value })
                                        });

                                        const data = await response.json();
                                        if (data.success) {
                                            let user = null;
                                            for (const [, u] of users.entries()) {
                                                if (u.userId === userId) { user = u; break; }
                                            }
                                            if (user) {
                                                user.excuseType = value;
                                                user.isExcused = value === 'excused' || value === 'on_duty';
                                                user.attendanceId = attendanceId;
                                                renderEmployeesTable();
                                            }
                                        } else {
                                            alert('Xatolik: ' + (data.message || 'Status yangilashda xatolik'));
                                        }
                                    } catch (error) {
                                        console.error('Error updating excuse status:', error);
                                        alert('Xatolik: Server bilan aloqa qilishda muammo');
                                    }
                                    dropdown.style.display = 'none';
                                });
                            });
                        });
                        
                        // Click outside to close dropdowns
                        document.addEventListener('click', function(e) {
                            if (!e.target.closest('.excuse-badge-wrapper')) {
                                document.querySelectorAll('.excuse-dropdown-menu').forEach(menu => {
                                    menu.style.display = 'none';
                                });
                            }
                        });
                    }, 100);
                }

                if (usersTotalEl) {
                    usersTotalEl.textContent = String(allUsers.length);
                }

                // Update came count (users who came today)
                const usersCameTotalEl = document.getElementById('usersCameTotal');
                if (usersCameTotalEl) {
                    usersCameTotalEl.textContent = String(allUsers.length);
                }

                // Update absent count (users who haven't come today)
                const usersAbsentTotalEl = document.getElementById('usersAbsentTotal');
                if (usersAbsentTotalEl) {
                    // Absent xodimlar soni = faqat absent bo'lganlar
                    const absentCount = allUsers.filter(u => u.isAbsent === true).length;
                    usersAbsentTotalEl.textContent = String(absentCount);
                }

                // Update status cards
                updateStatusCards(allUsers);

                // Update department chart
                renderDepartmentChart();

                // Update active employees cards
                renderActiveEmployeesCards(allUsers);
            }

            // Render active employees cards - last 30 days
            function renderActiveEmployeesCards(allUsers) {
                // Filter active employees (who came in last 30 days)
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                thirtyDaysAgo.setHours(0, 0, 0, 0);

                const activeUsers = allUsers.filter(user => {
                    // Use lastArrivalTime if available, otherwise use lastSeenAt
                    const timeToCheck = user.lastArrivalTime || user.lastSeenAt;
                    if (!timeToCheck) return false;
                    const userDate = new Date(timeToCheck);
                    return userDate.getTime() >= thirtyDaysAgo.getTime() && userDate.getTime() <= today.getTime();
                });

                // Sort by monthly average KPI (highest first), then by arrival time
                activeUsers.sort((a, b) => {
                    const aKPI = calculateMonthlyKPI(a);
                    const bKPI = calculateMonthlyKPI(b);
                    if (aKPI !== bKPI) {
                        return bKPI - aKPI; // Sort by monthly KPI descending
                    }
                    const aTime = a.lastArrivalTime || a.lastSeenAt;
                    const bTime = b.lastArrivalTime || b.lastSeenAt;
                    if (!aTime) return 1;
                    if (!bTime) return -1;
                    return new Date(bTime) - new Date(aTime);
                });

                // Render single card with all active users
                renderActiveEmployeeCard('activeEmployeesList', activeUsers);
            }

            function renderActiveEmployeeCard(containerId, users) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (users.length === 0) {
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 200px; color: #6b7280; text-align: center;">Ma\'lumotlar yo\'q</div>';
                    return;
                }

                container.innerHTML = users.map((user, index) => {
                    const initials = (user.name || 'U')
                        .split(' ')
                        .filter(Boolean)
                        .map(p => p[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase() || 'U';

                    // Use lastArrivalTime if available, otherwise use lastSeenAt for display
                    const timeToDisplay = user.lastArrivalTime || user.lastSeenAt;

                    const arrivalTime = timeToDisplay
                        ? new Date(timeToDisplay).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        })
                        : '-';

                    let statusBadge = '';
                    if (user.isAbsent) {
                        statusBadge = '<span class="active-employee-badge badge-absent"></span>';
                    } else if (user.minutesLateToday > 0) {
                        statusBadge = `<span class="active-employee-badge badge-late">${user.minutesLateToday} min kech</span>`;
                    } else {
                        statusBadge = '<span class="active-employee-badge badge-ontime">Vaqtida</span>';
                    }

                    const avatarHtml = user.imageUrl
                        ? `<img src="${user.imageUrl}" alt="${user.name || ''}">`
                        : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #667eea; color: white; font-weight: 600;">${initials}</div>`;

                    const organization = user.organization || 'Lavozim ko\'rsatilmagan';

                    // Calculate monthly average KPI
                    const monthlyKPI = calculateMonthlyKPI(user);
                    
                    // Determine KPI class based on value
                    let kpiClass = '';
                    if (monthlyKPI >= 100) {
                        kpiClass = 'kpi-high';
                    } else if (monthlyKPI >= 50) {
                        kpiClass = 'kpi-medium';
                    } else {
                        kpiClass = 'kpi-low';
                    }

                    // Employee number (1-based index)
                    const employeeNumber = index + 1;

                    return `
                <div class="active-employee-item">
                    <div style="min-width: 30px; text-align: center; font-weight: 700; font-size: 1rem; color: #6b7280;">${employeeNumber}</div>
                    <div class="active-employee-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="active-employee-info">
                        <div class="active-employee-name">${user.name || 'Noma\'lum'}</div>
                        <div class="active-employee-details">${organization}</div>
                    </div>
                    <div class="active-employee-status">
                        <div class="active-employee-kpi ${kpiClass}">${monthlyKPI}%</div>
                        ${statusBadge}
                    </div>
                </div>
            `;
                }).join('');
            }

            function updateStatusCards(allUsers) {
                let filteredUsers = filterUsersByStatisticsPeriod(allUsers, 'daily');

                const ontimeCount = filteredUsers.filter(u => !u.isAbsent && u.minutesLateToday === 0).length;
                const lateCount = filteredUsers.filter(u => !u.isAbsent && u.minutesLateToday > 0).length;
                const absentCount = filteredUsers.filter(u => u.isAbsent === true).length;
                const totalCame = filteredUsers.filter(u => !u.isAbsent).length;

                // Kelganlar / jami xodimlar: jami = bazadagi barcha xodimlar soni
                const totalAll = totalEmployeesCount > 0 ? totalEmployeesCount : filteredUsers.length;

                const totalAbsent = absentCount;
                const totalForChart = filteredUsers.length > 0 ? filteredUsers.length : 1;

                const statTotalCameEl = document.getElementById('statTotalCame');
                const statTotalAllEl = document.getElementById('statTotalAll');
                if (statTotalCameEl) statTotalCameEl.textContent = String(totalCame);
                if (statTotalAllEl) statTotalAllEl.textContent = String(totalAll);

                const ontimePercent = totalForChart > 0 ? Math.round((ontimeCount / totalForChart) * 100) : 0;
                const latePercent = totalForChart > 0 ? Math.round((lateCount / totalForChart) * 100) : 0;
                const absentPercent = totalForChart > 0 ? Math.round((totalAbsent / totalForChart) * 100) : 0;

                // Update percentage displays
                const statOntimePercentEl = document.getElementById('statOntimePercent');
                const statLatePercentEl = document.getElementById('statLatePercent');
                const statAbsentPercentEl = document.getElementById('statAbsentPercent');

                if (statOntimePercentEl) statOntimePercentEl.textContent = String(ontimePercent);
                if (statLatePercentEl) statLatePercentEl.textContent = String(latePercent);
                if (statAbsentPercentEl) statAbsentPercentEl.textContent = String(absentPercent);

                // Update arc chart paths based on percentages
                updateArcChart(ontimePercent, latePercent, absentPercent);
            }

            function updateArcChart(ontimePercent, latePercent, absentPercent) {
                // Ensure we have valid percentages
                const total = ontimePercent + latePercent + absentPercent;
                const normalizedTotal = total > 0 ? total : 100;

                // Normalize percentages to ensure they sum to 100
                const normalizedOntime = total > 0 ? ontimePercent : 0;
                const normalizedLate = total > 0 ? latePercent : 0;
                const normalizedAbsent = total > 0 ? absentPercent : (total === 0 ? 100 : absentPercent);

                const ontimeAngle = (normalizedOntime / normalizedTotal) * 360;
                const lateAngle = (normalizedLate / normalizedTotal) * 360;
                const absentAngle = (normalizedAbsent / normalizedTotal) * 360;

                const radius = 80;
                const centerX = 100;
                const centerY = 100;

                let currentAngle = -90; // Start from top

                // Draw ontime arc (green)
                if (normalizedOntime > 0) {
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + ontimeAngle;
                    const path1 = createArcPath(centerX, centerY, radius, startAngle, endAngle);
                    const arcOntime = document.getElementById('arc-ontime');
                    if (arcOntime) {
                        arcOntime.setAttribute('d', path1);
                        arcOntime.style.display = 'block';
                    }
                    currentAngle = endAngle;
                } else {
                    const arcOntime = document.getElementById('arc-ontime');
                    if (arcOntime) {
                        arcOntime.setAttribute('d', '');
                        arcOntime.style.display = 'none';
                    }
                }

                // Draw late arc (orange)
                if (normalizedLate > 0) {
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + lateAngle;
                    const path2 = createArcPath(centerX, centerY, radius, startAngle, endAngle);
                    const arcLate = document.getElementById('arc-late');
                    if (arcLate) {
                        arcLate.setAttribute('d', path2);
                        arcLate.style.display = 'block';
                    }
                    currentAngle = endAngle;
                } else {
                    const arcLate = document.getElementById('arc-late');
                    if (arcLate) {
                        arcLate.setAttribute('d', '');
                        arcLate.style.display = 'none';
                    }
                }

                // Draw absent arc (grey)
                if (normalizedAbsent > 0) {
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + absentAngle;
                    const path3 = createArcPath(centerX, centerY, radius, startAngle, endAngle);
                    const arcAbsent = document.getElementById('arc-absent');
                    if (arcAbsent) {
                        arcAbsent.setAttribute('d', path3);
                        arcAbsent.style.display = 'block';
                    }
                } else {
                    const arcAbsent = document.getElementById('arc-absent');
                    if (arcAbsent) {
                        arcAbsent.setAttribute('d', '');
                        arcAbsent.style.display = 'none';
                    }
                }
            }

            function createArcPath(centerX, centerY, radius, startAngleDeg, endAngleDeg) {
                const startRad = (startAngleDeg * Math.PI) / 180;
                const endRad = (endAngleDeg * Math.PI) / 180;

                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);

                const angleDiff = endAngleDeg - startAngleDeg;
                const largeArcFlag = Math.abs(angleDiff) > 180 ? 1 : 0;
                const sweepFlag = 1; // Always clockwise

                return `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} ${sweepFlag} ${x2} ${y2}`;
            }

            function exportToExcel() {
                let allUsers = Array.from(users.values());
                allUsers = filterUsersByPeriod(allUsers, currentPeriod);

                // Sort same as table
                allUsers.sort((a, b) => {
                    const aLate = a.minutesLateToday > 0;
                    const bLate = b.minutesLateToday > 0;
                    if (aLate && !bLate) return -1;
                    if (!aLate && bLate) return 1;
                    if (aLate && bLate) {
                        return (b.minutesLateToday || 0) - (a.minutesLateToday || 0);
                    }
                    return new Date(b.lastSeenAt) - new Date(a.lastSeenAt);
                });

                // Prepare CSV data
                const headers = ['ID', 'Name', 'BO\'LIM', 'LAVOZIM', 'TELEFON', 'EMAIL', 'Date', 'Time', 'Lateness', 'KPI %'];
                const rows = [headers];

                for (const user of allUsers) {
                    // Use lastArrivalTime if available, otherwise use lastSeenAt for display
                    const timeToDisplay = user.lastArrivalTime || user.lastSeenAt;

                    const arrivalDate = timeToDisplay
                        ? new Date(timeToDisplay).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        })
                        : '-';

                    const arrivalTime = timeToDisplay
                        ? new Date(timeToDisplay).toLocaleTimeString('en-US', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        })
                        : '-';

                    let lateText = '';
                    if (user.hasDeparted) {
                        const departureTime = user.lastDepartureTime
                            ? new Date(user.lastDepartureTime).toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            })
                            : '-';
                        lateText = `Ketdi: ${departureTime}`;
                    } else if (user.isAbsent) {
                        lateText = 'Kelmagan';
                    } else if (user.minutesLateToday > 0) {
                        lateText = `${user.minutesLateToday} min kech`;
                    } else {
                        lateText = 'Vaqtida';
                    }

                    const prod = computeProductivity(user);
                    const kpiPercent = prod.percent + '%';

                    rows.push([
                        user.userId || '-',
                        user.name || '-',
                        user.department_name || '-',
                        user.position || user.organization || '-',
                        user.phone || '-',
                        user.email || '-',
                        arrivalDate,
                        arrivalTime,
                        lateText,
                        kpiPercent
                    ]);
                }

                // Create workbook and worksheet using SheetJS
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);

                // Set column widths
                const colWidths = [
                    { wch: 10 }, // ID
                    { wch: 20 }, // Name
                    { wch: 20 }, // BO'LIM
                    { wch: 20 }, // LAVOZIM
                    { wch: 15 }, // TELEFON
                    { wch: 25 }, // EMAIL
                    { wch: 12 }, // Date
                    { wch: 12 }, // Time
                    { wch: 15 }, // Lateness
                    { wch: 10 }  // KPI %
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "O'rmon agentligi KPI");

                // Generate filename with date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const periodStr = currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1);
                const filename = `O'rmon agentligi KPI_${periodStr}_${dateStr}.xlsx`;

                // Write file and download
                XLSX.writeFile(wb, filename);
            }

            let currentUser = null;
            const processedEventIds = new Set(); // For deduplication

            // Load history events from DB
            async function loadHistoryEvents() {
                try {
                    const res = await fetch('/api/public/events');
                    const data = await res.json();

                    if (!data || !data.success) return;

                    const rows = Array.isArray(data.rows) ? data.rows.slice().reverse() : [];

                    rows.forEach(ev => {
                        const eventObj = {
                            id: ev.id,
                            code: ev.code,
                            action: ev.action,
                            data: ev.event_data,
                            receivedAt: ev.received_at
                        };

                        updateCurrentSummary(eventObj);
                        updateUsersFromEvent(eventObj);
                    });
                } catch (e) {
                    console.error('[History] Error:', e);
                }
            }


            // Check authentication on page load
            async function checkAuth() {
                try {
                    const response = await fetch('/api/session');
                    const data = await response.json();
                    if (!data.success) {
                        window.location.href = '/login.html';
                        return false;
                    }
                    currentUser = data.user;
                    // User authenticated
                    updateUserInfo();
                    return true;
                } catch (err) {
                    console.error('Auth check failed:', err);
                    window.location.href = '/login.html';
                    return false;
                }
            }

            function updateUserInfo() {
                let userName = currentUser ? (currentUser.fullName || currentUser.username || 'A.Turdiyev') : 'A.Turdiyev';
                // Replace "Administrator" with "A.Turdiyev"
                if (userName === 'Administrator' || userName === 'administrator') {
                    userName = 'A.Turdiyev';
                }
                let userRole = currentUser ? (currentUser.role || 'superadmin') : 'superadmin';
                if (userRole.toLowerCase() === 'superadmin') {
                    userRole = 'SUPER ADMIN';
                } else {
                    userRole = userRole.toUpperCase();
                }

                // Update all dashboard headers user info
                const dashboardUserNames = [
                    'dashboardUserName', 'orgDashboardUserName', 'deptDashboardUserName',
                    'empDashboardUserName', 'posDashboardUserName', 'timeDashboardUserName',
                    'settingsDashboardUserName'
                ];
                const dashboardUserRoles = [
                    'dashboardUserRole', 'orgDashboardUserRole', 'deptDashboardUserRole',
                    'empDashboardUserRole', 'posDashboardUserRole', 'timeDashboardUserRole',
                    'settingsDashboardUserRole'
                ];

                dashboardUserNames.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = userName;
                });

                // Role display removed - only showing user name with checkmark icon
                // dashboardUserRoles.forEach(id => {
                //     const el = document.getElementById(id);
                //     if (el) el.textContent = userRole;
                // });

                // Update sidebar menu based on role
                updateSidebarMenuByRole(currentUser ? currentUser.role : 'admin');

                // Re-render table and apply admin-only visibility (edit buttons)
                setTimeout(() => {
                    if (typeof renderEmployeesTable === 'function') renderEmployeesTable();
                    applyAdminOnlyVisibility();
                }, 200);
            }

            function isAdminUser() {
                if (!currentUser) return false;
                const r = (currentUser.role || '').toString().toLowerCase();
                const u = (currentUser.username || '').toString().toLowerCase();
                return r === 'admin' || r === 'superadmin' || u === 'admin' || u === 'superadmin';
            }

            function applyAdminOnlyVisibility() {
                const isAdmin = isAdminUser();
                document.querySelectorAll('.admin-only').forEach(el => {
                    if (isAdmin) el.classList.add('show');
                    else el.classList.remove('show');
                });
            }

            // Update sidebar menu based on user role. Superadmin: barcha oynalar va imkoniyatlar.
            function updateSidebarMenuByRole(userRole) {
                const role = (userRole || '').toLowerCase();
                const menuItems = document.querySelectorAll('.sidebar-menu-item');
                const addAdminEl = document.getElementById('addAdminMenuItem');

                menuItems.forEach(item => {
                    const link = item.querySelector('.sidebar-menu-link');
                    if (!link) return;
                    const linkText = link.textContent.trim();
                    const isLogout = linkText === 'Chiqish' || (link.href && link.href.includes('login.html'));

                    if (role === 'superadmin' || role === 'admin') {
                        item.style.display = '';
                    } else if (role === 'kadr') {
                        const show = linkText === 'Dashboard' || linkText === 'Tashkilotlar' || linkText === 'Bo\'limlar' ||
                            linkText === 'Lavozimlar' || linkText === 'Xodimlar' || linkText === 'Sozlamalar' || isLogout;
                        item.style.display = show ? '' : 'none';
                    } else if (role === 'foydalanuvchi') {
                        const show = linkText === 'Dashboard' || linkText === 'Sozlamalar' || isLogout;
                        item.style.display = show ? '' : 'none';
                    } else {
                        item.style.display = '';
                    }
                });
                if (addAdminEl && (role === 'superadmin' || role === 'admin')) addAdminEl.style.display = 'block';
            }

            // Edit Employee Modal Functions (global for onclick)
            window.openEditModal = function (userId, name, position, organization, photoUrl) {
                const modal = document.getElementById('editEmployeeModal');
                const userIdInput = document.getElementById('editUserId');
                const fullNameInput = document.getElementById('editFullName');
                const positionInput = document.getElementById('editPosition');
                const organizationInput = document.getElementById('editOrganization');
                const photoPreview = document.getElementById('currentPhotoPreview');
                const photoPlaceholder = document.getElementById('photoPlaceholder');
                const photoInput = document.getElementById('photoInput');

                userIdInput.value = userId;
                fullNameInput.value = name || '';
                positionInput.value = position || '';
                organizationInput.value = organization || '';

                // Show current photo
                if (photoUrl) {
                    photoPreview.innerHTML = `<img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span id=\\'photoPlaceholder\\'>Rasm yo'q</span>'">`;
                } else {
                    photoPreview.innerHTML = '<span id="photoPlaceholder">No photo</span>';
                }

                photoInput.value = '';
                modal.style.display = 'flex';

                // Preview selected image
                photoInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            photoPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function closeEditModal() {
                const modal = document.getElementById('editEmployeeModal');
                modal.style.display = 'none';
                document.getElementById('editEmployeeForm').reset();
            }

            // Modal event listeners
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

            // Close modal when clicking outside
            document.getElementById('editEmployeeModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });

            // Handle form submission
            document.getElementById('editEmployeeForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const userId = document.getElementById('editUserId').value;
                const fullName = document.getElementById('editFullName').value;
                const phone = document.getElementById('editPhone').value;
                const email = document.getElementById('editEmail').value;
                const positionSelect = document.getElementById('editPosition');
                const departmentSelect = document.getElementById('editDepartment');
                const position = positionSelect ? positionSelect.options[positionSelect.selectedIndex]?.text || positionSelect.value : '';
                const departmentId = departmentSelect ? departmentSelect.value : null;
                const photoInput = document.getElementById('photoInput');

                let photoBase64 = null;
                if (photoInput.files[0]) {
                    const file = photoInput.files[0];
                    photoBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                try {
                    const data = {
                        full_name: fullName || null,
                        phone: phone || null,
                        email: email || null,
                        position: position || null,
                        department_id: departmentId || null
                    };

                    if (photoBase64) {
                        data.photo_base64 = photoBase64;
                    }

                    // Also update employees management list if it's open
                    if (document.getElementById('employeesSection') && document.getElementById('employeesSection').style.display !== 'none') {
                        // Will reload after update
                    }

                    const response = await fetch(`/api/employees/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Employee ma\'lumotlari muvaffaqiyatli yangilandi!');
                        closeEditModal();
                        // Load updated employee data and merge with existing user data
                        await loadEmployeeData(userId);
                        renderEmployeesTable();
                        // Reload employees management list if it's open
                        if (document.getElementById('employeesSection') && document.getElementById('employeesSection').style.display !== 'none') {
                            await loadEmployeesForManagement();
                        }
                    } else {
                        const errorMsg = result.message || 'Failed to update employee';
                        console.error('Update error:', errorMsg);
                        alert('Xatolik: ' + errorMsg);
                    }
                } catch (err) {
                    console.error('Error updating employee:', err);
                    alert('Xatolik: ' + (err.message || 'Server bilan aloqa o\'rnatib bo\'lmadi. Iltimos, qayta urinib ko\'ring.'));
                }
            });

            // Delete employee function
            window.deleteEmployee = async function (userId, userName) {
                if (!confirm(`Haqiqatan ham "${userName || userId}" ni o'chirmoqchimisiz?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/employees/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Foydalanuvchi muvaffaqiyatli o\'chirildi!');
                        // Remove from users map
                        users.delete(userId);
                        // Reload employee data
                        await loadAllEmployees();
                        // Re-render table
                        renderEmployeesTable();
                    } else {
                        alert('Xatolik: ' + (result.message || 'Foydalanuvchini o\'chirib bo\'lmadi'));
                    }
                } catch (err) {
                    console.error('Error deleting employee:', err);
                    alert('Xatolik yuz berdi. Iltimos, qayta urinib ko\'ring.');
                }
            };


            // Logout handler
            // Logout button handlers
            const logoutBtn = document.getElementById('logoutBtn');
            const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');

            const handleLogout = async () => {
                try {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/login.html';
                } catch (err) {
                    console.error('Logout failed:', err);
                    window.location.href = '/login.html';
                }
            };

            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            if (sidebarLogoutBtn) {
                sidebarLogoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleLogout();
                });
            }

            function connect() {
                if (eventSource) {
                    eventSource.close();
                }

                updateStatus(false);
                eventSource = new EventSource('/api/realtime');

                eventSource.onopen = () => {
                    updateStatus(true);
                };

                eventSource.onmessage = (e) => {
                    try {
                        const event = JSON.parse(e.data);
                        if (event.type === 'connected' || event.type === 'ping') return;
                        eventCount++;
                        if (eventCountEl) eventCountEl.textContent = String(eventCount);
                        updateCurrentSummary(event);
                        updateUsersFromEvent(event);
                        // renderEmployeesTable() is already called in updateUsersFromEvent()
                    } catch (err) {
                        console.error('Error parsing event:', err, 'Raw data:', e.data);
                    }
                };

                eventSource.onerror = (err) => {
                    console.error('[SSE] Connection error:', err);
                    updateStatus(false);
                    eventSource.close();
                    setTimeout(connect, 3000);
                };
            }

            // Time period filter select, status filter, search input, statistics period, and export button
            // Global time settings
            let timeSettings = {
                onTimeThreshold: { hours: 9, minutes: 10 },
                lateThreshold: { hours: 12, minutes: 0 },
                absentThreshold: { hours: 13, minutes: 0 },
                departureStartTime: { hours: 18, minutes: 0 }
            };

            // Load time settings from API (global, for dashboard logic)
            async function loadTimeSettings() {
                try {
                    const response = await fetch('/api/time-settings', { credentials: 'include' });
                    const data = await response.json();
                    if (data.success && data.settings) {
                        const parseTime = (timeStr) => {
                            const [hours, minutes] = (timeStr || '').split(':').map(Number);
                            return { hours: hours || 0, minutes: minutes || 0 };
                        };
                        timeSettings = {
                            onTimeThreshold: parseTime(data.settings.onTimeThreshold),
                            lateThreshold: parseTime(data.settings.lateThreshold),
                            absentThreshold: parseTime(data.settings.absentThreshold),
                            departureStartTime: parseTime(data.settings.departureStartTime)
                        };
                    }
                } catch (error) {
                    console.error('Error loading time settings:', error);
                }
            }

            document.addEventListener('DOMContentLoaded', async () => {
                // Load time settings first
                await loadTimeSettings();

                const periodSelect = document.getElementById('periodSelect');
                if (periodSelect) {
                    currentPeriod = 'daily';
                    periodSelect.value = 'daily';

                    periodSelect.addEventListener('change', (e) => {
                        currentPeriod = e.target.value;
                        renderEmployeesTable();
                    });
                }

                const statusFilterSelect = document.getElementById('statusFilter');
                if (statusFilterSelect) {
                    statusFilter = 'all';
                    statusFilterSelect.value = 'all';

                    statusFilterSelect.addEventListener('change', (e) => {
                        statusFilter = e.target.value;
                        renderEmployeesTable();
                    });
                }

                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        searchQuery = e.target.value;
                        renderEmployeesTable();
                    });
                }


                // View all buttons
                window.viewAllStatistics = function () {
                    // Scroll to employees table
                    const employeesTable = document.querySelector('.employees-header');
                    if (employeesTable) {
                        employeesTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };

                window.viewAllDepartments = function () {
                    // Scroll to employees table
                    const employeesTable = document.querySelector('.employees-header');
                    if (employeesTable) {
                        employeesTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };

                window.viewAllActiveEmployees = function () {
                    // Scroll to employees table
                    const employeesTable = document.querySelector('.employees-header');
                    if (employeesTable) {
                        employeesTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };

                const exportBtn = document.getElementById('exportBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportToExcel);
                }
            });

            // Check auth before connecting
            checkAuth().then(async authenticated => {
                if (authenticated) {
                    // Load history events from DB first to restore state
                    await loadHistoryEvents();

                    // Load all employees data and merge
                    await loadAllEmployees();
                    
                    // Load today's attendance records for excuse status
                    await loadTodayAttendance();
                    
                    // Load monthly KPIs for active employees
                    await loadMonthlyKPIs();
                    
                    // Update monthly KPIs every 5 minutes
                    setInterval(loadMonthlyKPIs, 5 * 60 * 1000);

                    // Connect for real-time updates
                    connect();
                } else {
                    // Not authenticated, redirect to login
                    window.location.href = '/login.html';
                }
            }).catch(err => {
                console.error('Auth check failed:', err);
                // Try to connect anyway (fallback)
                loadAllEmployees().then(() => {
                    renderEmployeesTable();
                });
                connect();
            });

            // Organizations Management
            const organizationsSection = document.getElementById('organizationsSection');
            const dashboardSection = document.getElementById('dashboardSection');
            const createOrgBtn = document.getElementById('createOrgBtn');
            const organizationsList = document.getElementById('organizationsList');
            const organizationModal = document.getElementById('organizationModal');
            const organizationForm = document.getElementById('organizationForm');
            const organizationModalTitle = document.getElementById('organizationModalTitle');
            const closeOrgModal = document.getElementById('closeOrgModal');
            const cancelOrgBtn = document.getElementById('cancelOrgBtn');

            // Admin qo'shish modal elementlari
            const addAdminBtn = document.getElementById('addAdminBtn');
            const addAdminModal = document.getElementById('addAdminModal');
            const addAdminForm = document.getElementById('addAdminForm');
            const closeAddAdminModal = document.getElementById('closeAddAdminModal');
            const cancelAddAdminBtn = document.getElementById('cancelAddAdminBtn');
            const adminOrganizationSelect = document.getElementById('adminOrganization');
            const addAdminMenuItem = document.getElementById('addAdminMenuItem');

            // Sidebar menu click handlers
            document.querySelectorAll('.sidebar-menu-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    const section = this.getAttribute('data-section');
                    if (!section) return;

                    // Remove active class from all links
                    document.querySelectorAll('.sidebar-menu-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    // Hide all sections
                    if (dashboardSection) dashboardSection.style.display = 'none';
                    if (organizationsSection) organizationsSection.style.display = 'none';
                    const deptEl = document.getElementById('departmentsSection');
                    if (deptEl) deptEl.style.display = 'none';
                    const empEl = document.getElementById('employeesSection');
                    if (empEl) empEl.style.display = 'none';
                    const posEl = document.getElementById('positionsSection');
                    if (posEl) posEl.style.display = 'none';
                    const setEl = document.getElementById('settingsSection');
                    if (setEl) setEl.style.display = 'none';

                    // Show selected section
                    if (section === 'dashboard') {
                        if (dashboardSection) dashboardSection.style.display = 'block';
                    } else if (section === 'organizations') {
                        if (organizationsSection) {
                            organizationsSection.style.display = 'block';
                            loadOrganizations();
                            updateOrgSectionStats();
                        }
                    } else if (section === 'departments') {
                        if (deptEl) {
                            deptEl.style.display = 'block';
                            loadDepartments();
                        }
                    } else if (section === 'employees') {
                        if (empEl) {
                            empEl.style.display = 'block';
                            loadEmployeesForManagement();
                        }
                    } else if (section === 'positions') {
                        if (posEl) {
                            posEl.style.display = 'block';
                            loadPositions();
                        }
                    } else if (section === 'settings') {
                        if (setEl) setEl.style.display = 'block';
                    }
                });
            });

            // Load organizations
            async function loadOrganizations() {
                const tbody = document.getElementById('organizationsTableBody');
                if (!tbody) return;

                try {
                    const response = await fetch('/api/organizations', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.organizations) {
                            renderOrganizations(result.organizations);
                            // Update organization section statistics
                            updateOrgSectionStats();
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ¢</div><div class="org-empty-state-text">Hozircha tashkilotlar mavjud emas</div></div></td></tr>';
                        }
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                    }
                } catch (err) {
                    console.error('Error loading organizations:', err);
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                }
            }

            // Update organization section statistics (similar to dashboard)
            async function updateOrgSectionStats() {
                try {
                    // Get all users/employees data
                    const response = await fetch('/api/employees', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.employees) {
                            const allUsers = result.employees;
                            updateOrgStatusCards(allUsers);
                            renderOrgDepartmentChart();
                            renderOrgActiveEmployeeCard('orgActiveEmployeesList', allUsers);
                        }
                    }
                } catch (err) {
                    console.error('Error updating org section stats:', err);
                }
            }

            function updateOrgStatusCards(allUsers) {
                if (!document.getElementById('orgStatTotalCame')) return;
                const total = allUsers.length;
                let ontime = 0;
                let late = 0;
                let absent = 0;

                allUsers.forEach(user => {
                    if (user.isAbsent) {
                        absent++;
                    } else if (user.minutesLateToday > 0) {
                        late++;
                    } else {
                        ontime++;
                    }
                });

                const came = ontime + late;
                const ontimePercent = total > 0 ? Math.round((ontime / total) * 100) : 0;
                const latePercent = total > 0 ? Math.round((late / total) * 100) : 0;
                const absentPercent = total > 0 ? Math.round((absent / total) * 100) : 0;

                const el = (id) => document.getElementById(id);
                if (el('orgStatTotalCame')) el('orgStatTotalCame').textContent = came;
                if (el('orgStatTotalAll')) el('orgStatTotalAll').textContent = total;
                if (el('orgStatOntimePercent')) el('orgStatOntimePercent').textContent = ontimePercent;
                if (el('orgStatLatePercent')) el('orgStatLatePercent').textContent = latePercent;
                if (el('orgStatAbsentPercent')) el('orgStatAbsentPercent').textContent = absentPercent;

                if (total === 0) return;

                const radius = 80;
                const circumference = 2 * Math.PI * radius;
                const ontimeLength = (ontime / total) * circumference;
                const lateLength = (late / total) * circumference;
                const absentLength = (absent / total) * circumference;

                let currentAngle = -90;
                const centerX = 100;
                const centerY = 100;

                if (ontimeLength > 0) {
                    const endAngle = currentAngle + (ontime / total) * 360;
                    const startX = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                    const startY = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                    const endX = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                    const endY = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                    const largeArc = ontime / total > 0.5 ? 1 : 0;
                    const arc = el('orgArcOntime');
                    if (arc) arc.setAttribute('d', `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`);
                    currentAngle = endAngle;
                }

                if (lateLength > 0) {
                    const endAngle = currentAngle + (late / total) * 360;
                    const startX = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                    const startY = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                    const endX = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                    const endY = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                    const largeArc = late / total > 0.5 ? 1 : 0;
                    const arc = el('orgArcLate');
                    if (arc) arc.setAttribute('d', `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`);
                    currentAngle = endAngle;
                }

                if (absentLength > 0) {
                    const endAngle = currentAngle + (absent / total) * 360;
                    const startX = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                    const startY = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                    const endX = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                    const endY = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                    const largeArc = absent / total > 0.5 ? 1 : 0;
                    const arc = el('orgArcAbsent');
                    if (arc) arc.setAttribute('d', `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}`);
                }
            }

            function renderOrgDepartmentChart() {
                const container = document.getElementById('orgDepartmentChartContainer');
                if (!container) return;

                const departments = getDepartmentStats();

                if (departments.length === 0) {
                    container.innerHTML = '<div style="color: #6b7280; text-align: center; font-size: 0.875rem;">Ma\'lumotlar yo\'q</div>';
                    return;
                }

                const maxCount = Math.max(...departments.map(d => d.employeeCount), 1);
                let html = '';
                departments.forEach(dept => {
                    const percentage = (dept.employeeCount / maxCount) * 100;
                    html += `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 0.875rem; font-weight: 500; color: #111827;">${dept.name}</span>
                            <span style="font-size: 0.875rem; font-weight: 600; color: #111827;">${dept.employeeCount}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: #10b981; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
                });
                container.innerHTML = html;
            }

            function renderOrgActiveEmployeeCard(containerId, users) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (users.length === 0) {
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 200px; color: #6b7280; text-align: center;">Ma\'lumotlar yo\'q</div>';
                    return;
                }

                const activeUsers = users.filter(u => !u.isAbsent && (u.lastArrivalTime || u.lastSeenAt));
                activeUsers.sort((a, b) => {
                    const timeA = new Date(a.lastArrivalTime || a.lastSeenAt || 0);
                    const timeB = new Date(b.lastArrivalTime || b.lastSeenAt || 0);
                    return timeB - timeA;
                });

                container.innerHTML = activeUsers.slice(0, 6).map((user, index) => {
                    const initials = (user.name || 'U')
                        .split(' ')
                        .filter(Boolean)
                        .map(p => p[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase() || 'U';

                    const timeToDisplay = user.lastArrivalTime || user.lastSeenAt;
                    const arrivalTime = timeToDisplay
                        ? new Date(timeToDisplay).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        })
                        : '-';

                    let statusBadge = '';
                    if (user.minutesLateToday > 0) {
                        statusBadge = `<span style="padding: 2px 8px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Kechikdi</span>`;
                    } else if (!user.isAbsent) {
                        statusBadge = `<span style="padding: 2px 8px; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">Vaqtida</span>`;
                    }

                    return `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #f3f4f6; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb';" onmouseout="this.style.background='';">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; color: #ffffff; font-weight: 600; font-size: 0.875rem; flex-shrink: 0;">
                        ${initials}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 0.875rem; font-weight: 600; color: #111827; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user.name || user.card_name || 'Noma\'lum'}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${arrivalTime}</div>
                    </div>
                    ${statusBadge}
                </div>
            `;
                }).join('');
            }

            // Load organizations
            async function loadOrganizations() {
                try {
                    const response = await fetch('/api/organizations', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.organizations) {
                            renderOrganizations(result.organizations);
                        } else {
                            const tbody = document.getElementById('organizationsTableBody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ¢</div><div class="org-empty-state-text">Hozircha tashkilotlar mavjud emas</div></div></td></tr>';
                            }
                        }
                    } else {
                        const tbody = document.getElementById('organizationsTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                        }
                    }
                } catch (err) {
                    console.error('Error loading organizations:', err);
                    const tbody = document.getElementById('organizationsTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                    }
                }
            }

            // Render organizations list
            function renderOrganizations(orgs) {
                const tbody = document.getElementById('organizationsTableBody');
                if (!tbody) return;

                if (orgs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ¢</div><div class="org-empty-state-text">Hozircha tashkilotlar mavjud emas</div></div></td></tr>';
                    if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
                    return;
                }

                tbody.innerHTML = orgs.map((org, index) => `
            <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" 
                onmouseover="this.style.background='#f9fafb'" 
                onmouseout="this.style.background='#ffffff'">
                <td style="padding: 14px 16px; color: #6b7280; font-weight: 500; font-size: 0.875rem;">
                    ${index + 1}
                </td>
                <td style="padding: 14px 16px; color: #111827; font-weight: 600; font-size: 0.875rem;">
                    ${org.name || '-'}
                </td>
                <td style="padding: 14px 16px; color: #111827; font-weight: 500; font-size: 0.875rem;">
                    ${org.employee_count || '-'}
                </td>
                <td style="padding: 14px 16px; color: #111827; font-weight: 500; font-size: 0.875rem;">
                    ${org.phone || '<span style="color: #9ca3af;">-</span>'}
                </td>
                <td style="padding: 14px 16px; color: #111827; font-weight: 500; font-size: 0.875rem;">
                    ${org.email || '<span style="color: #9ca3af;">-</span>'}
                </td>
                <td class="admin-only" style="padding: 14px 16px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <button onclick="editOrganization(${org.id}, '${(org.name || '').replace(/'/g, "\\'")}', '', '${(org.phone || '').replace(/'/g, "\\'")}', '${(org.email || '').replace(/'/g, "\\'")}', '${(org.employee_count || '').toString().replace(/'/g, "\\'")}')" 
                            style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" 
                            onmouseover="this.style.background='#059669';" 
                            onmouseout="this.style.background='#10b981';" 
                            title="Tahrirlash">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: white;">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button onclick="deleteOrganization(${org.id}, '${(org.name || '').replace(/'/g, "\\'")}')" 
                            style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" 
                            onmouseover="this.style.background='#dc2626';" 
                            onmouseout="this.style.background='#ef4444';" 
                            title="O'chirish">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: white;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
            }

            // Check user role and show/hide admin add button
            async function checkUserRole() {
                try {
                    const response = await fetch('/api/session', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.user) {
                            const r = (result.user.role || '').toString().toLowerCase();
                            const u = (result.user.username || '').toString().toLowerCase();
                            const admin = r === 'admin' || r === 'superadmin' || u === 'admin' || u === 'superadmin';
                            if (addAdminMenuItem) addAdminMenuItem.style.display = admin ? 'block' : 'none';
                        }
                    }
                } catch (err) {
                    console.error('Error checking user role:', err);
                }
            }

            // Load organizations for admin select
            async function loadOrganizationsForAdmin() {
                if (!adminOrganizationSelect) return;

                try {
                    const response = await fetch('/api/organizations', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.organizations) {
                            adminOrganizationSelect.innerHTML = '<option value="">Tashkilotni tanlang (ixtiyoriy)</option>' +
                                result.organizations.map(org =>
                                    `<option value="${org.id}">${org.name || '-'}</option>`
                                ).join('');
                        }
                    }
                } catch (err) {
                    console.error('Error loading organizations for admin select:', err);
                }
            }

            // Admin qo'shish modalini ochish
            if (addAdminBtn) {
                addAdminBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (addAdminModal) {
                        loadOrganizationsForAdmin();
                        addAdminModal.style.display = 'flex';
                    }
                });
            }

            // Admin qo'shish modalini yopish
            if (closeAddAdminModal) {
                closeAddAdminModal.addEventListener('click', () => {
                    if (addAdminModal) {
                        addAdminModal.style.display = 'none';
                        if (addAdminForm) addAdminForm.reset();
                    }
                });
            }

            if (cancelAddAdminBtn) {
                cancelAddAdminBtn.addEventListener('click', () => {
                    if (addAdminModal) {
                        addAdminModal.style.display = 'none';
                        if (addAdminForm) addAdminForm.reset();
                    }
                });
            }

            // Close modal when clicking outside
            if (addAdminModal) {
                addAdminModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        addAdminModal.style.display = 'none';
                        if (addAdminForm) addAdminForm.reset();
                    }
                });
            }

            // Admin qo'shish form submit
            if (addAdminForm) {
                addAdminForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const username = document.getElementById('adminUsername').value.trim();
                    const password = document.getElementById('adminPassword').value;
                    const fullName = document.getElementById('adminFullName').value.trim();
                    const role = document.getElementById('adminRole').value;
                    const organizationId = document.getElementById('adminOrganization').value || null;

                    if (!username || !password) {
                        alert('Username va password majburiy maydonlar');
                        return;
                    }

                    try {
                        const response = await fetch('/api/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                username,
                                password,
                                full_name: fullName || null,
                                role: role || 'user',
                                organization_id: organizationId ? parseInt(organizationId) : null
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Admin muvaffaqiyatli qo\'shildi!');
                            if (addAdminModal) {
                                addAdminModal.style.display = 'none';
                                addAdminForm.reset();
                            }
                        } else {
                            alert('Xatolik: ' + (result.message || 'Admin qo\'shib bo\'lmadi'));
                        }
                    } catch (err) {
                        console.error('Error creating admin:', err);
                        alert('Xatolik: ' + (err.message || 'Server bilan aloqa o\'rnatib bo\'lmadi'));
                    }
                });
            }

            // Check user role on page load
            checkUserRole();

            // Create organization button
            if (createOrgBtn) {
                createOrgBtn.addEventListener('click', () => {
                    organizationModalTitle.textContent = 'Tashkilot qo\'shish';
                    organizationForm.reset();
                    document.getElementById('orgId').value = '';
                    organizationModal.style.display = 'flex';
                });
            }

            // Close modal
            if (closeOrgModal) {
                closeOrgModal.addEventListener('click', () => {
                    organizationModal.style.display = 'none';
                });
            }

            if (cancelOrgBtn) {
                cancelOrgBtn.addEventListener('click', () => {
                    organizationModal.style.display = 'none';
                });
            }

            // Close modal when clicking outside
            if (organizationModal) {
                organizationModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        organizationModal.style.display = 'none';
                    }
                });
            }

            // Edit organization
            window.editOrganization = function (id, name, description, phone, email, employee_count) {
                organizationModalTitle.textContent = 'Tashkilotni tahrirlash';
                document.getElementById('orgId').value = id;
                document.getElementById('orgName').value = name || '';
                document.getElementById('orgPhone').value = phone || '';
                document.getElementById('orgEmail').value = email || '';
                document.getElementById('orgEmployeeCount').value = employee_count || '';
                organizationModal.style.display = 'flex';
            };

            // Delete organization
            window.deleteOrganization = async function (id, name) {
                if (!confirm(`Haqiqatan ham "${name || 'Tashkilot'}" ni o'chirmoqchimisiz?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/organizations/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Tashkilot muvaffaqiyatli o\'chirildi!');
                        loadOrganizations();
                    } else {
                        alert('Xatolik: ' + (result.message || 'Tashkilotni o\'chirib bo\'lmadi'));
                    }
                } catch (err) {
                    console.error('Error deleting organization:', err);
                    alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                }
            };

            // Organization form submit
            if (organizationForm) {
                organizationForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const orgId = document.getElementById('orgId').value;
                    const name = document.getElementById('orgName').value.trim();
                    const phone = document.getElementById('orgPhone').value.trim();
                    const email = document.getElementById('orgEmail').value.trim();
                    const ecEl = document.getElementById('orgEmployeeCount');
                    const ecRaw = ecEl ? ecEl.value.trim() : '';
                    const ecNum = ecRaw === '' ? 0 : parseInt(ecEl.value, 10);
                    const employee_count = (typeof ecNum === 'number' && !Number.isNaN(ecNum) && ecNum >= 0) ? ecNum : 0;

                    if (!name) {
                        alert('Tashkilot nomini kiriting!');
                        return;
                    }
                    if (ecRaw !== '' && (Number.isNaN(ecNum) || ecNum < 0)) {
                        alert('Xodimlari soni butun musbat son bo\'lishi kerak.');
                        return;
                    }

                    try {
                        const url = orgId ? `/api/organizations/${orgId}` : '/api/organizations';
                        const method = orgId ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                name: name,
                                phone: phone || null,
                                email: email || null,
                                employee_count: employee_count
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(orgId ? 'Tashkilot muvaffaqiyatli yangilandi!' : 'Tashkilot muvaffaqiyatli yaratildi!');
                            organizationModal.style.display = 'none';
                            organizationForm.reset();
                            loadOrganizations();
                        } else {
                            alert('Xatolik: ' + (result.message || 'Tashkilotni saqlab bo\'lmadi'));
                        }
                    } catch (err) {
                        console.error('Error saving organization:', err);
                        alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                    }
                });
            }

            // Departments Management
            const departmentsSection = document.getElementById('departmentsSection');
            const createDeptBtn = document.getElementById('createDeptBtn');
            const departmentsList = document.getElementById('departmentsList');
            const departmentModal = document.getElementById('departmentModal');
            const departmentForm = document.getElementById('departmentForm');
            const departmentModalTitle = document.getElementById('departmentModalTitle');
            const closeDeptModal = document.getElementById('closeDeptModal');
            const cancelDeptBtn = document.getElementById('cancelDeptBtn');
            const deptOrganizationSelect = document.getElementById('deptOrganization');

            // Load departments
            async function loadDepartments() {
                try {
                    const response = await fetch('/api/departments', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.departments) {
                            renderDepartments(result.departments);
                        } else {
                            const tbody = document.getElementById('departmentsTableBody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ“‚</div><div class="org-empty-state-text">Hozircha bo\'limlar mavjud emas</div></div></td></tr>';
                            }
                        }
                    } else {
                        const tbody = document.getElementById('departmentsTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                        }
                    }
                } catch (err) {
                    console.error('Error loading departments:', err);
                    const tbody = document.getElementById('departmentsTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                    }
                }
            }

            // Load organizations for dropdown
            async function loadOrganizationsForSelect() {
                try {
                    const response = await fetch('/api/organizations', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.organizations) {
                            deptOrganizationSelect.innerHTML = '<option value="">Tashkilotni tanlang</option>' +
                                result.organizations.map(org =>
                                    `<option value="${org.id}">${org.name || '-'}</option>`
                                ).join('');
                        }
                    }
                } catch (err) {
                    console.error('Error loading organizations for select:', err);
                }
            }

            // Render departments list
            function renderDepartments(depts) {
                const tbody = document.getElementById('departmentsTableBody');
                if (!tbody) return;

                if (depts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ“‚</div><div class="org-empty-state-text">Hozircha bo\'limlar mavjud emas</div></div></td></tr>';
                    if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
                    return;
                }

                tbody.innerHTML = depts.map((dept, index) => `
            <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background=''">
                <td style="padding: 12px 16px; color: #6b7280; font-weight: 500;">${index + 1}</td>
                <td style="padding: 12px 16px; color: #111827; font-weight: 600;">${dept.name || '-'}</td>
                <td style="padding: 12px 16px; color: #111827;">${dept.organization_name || '-'}</td>
                <td style="padding: 12px 16px; color: #111827;">${dept.description || 'Tavsif ko\'rsatilmagan'}</td>
                <td class="admin-only" style="padding: 12px 16px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <button onclick="editDepartment(${dept.id}, '${(dept.name || '').replace(/'/g, "\\'")}', '${(dept.description || '').replace(/'/g, "\\'")}', ${dept.organization_id || 'null'})" style="padding: 6px 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Tahrirlash">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: white;">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button onclick="deleteDepartment(${dept.id}, '${(dept.name || '').replace(/'/g, "\\'")}')" style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="O'chirish">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: white;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
                if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
            }

            // Create department button
            if (createDeptBtn) {
                createDeptBtn.addEventListener('click', async () => {
                    departmentModalTitle.textContent = 'Bo\'lim yaratish';
                    departmentForm.reset();
                    document.getElementById('deptId').value = '';
                    await loadOrganizationsForSelect();
                    departmentModal.style.display = 'flex';
                });
            }

            // Create employee button
            const createEmployeeBtn = document.getElementById('createEmployeeBtn');
            if (createEmployeeBtn) {
                createEmployeeBtn.addEventListener('click', async () => {
                    // Reset form
                    document.getElementById('editUserId').value = '';
                    document.getElementById('editFullName').value = '';
                    document.getElementById('editPhone').value = '';
                    document.getElementById('editEmail').value = '';
                    document.getElementById('editDepartment').value = '';
                    document.getElementById('editPosition').value = '';

                    // Load departments and positions
                    await loadDepartmentsForEmployeeSelect();
                    await loadPositionsForEmployeeSelect();

                    // Reset photo preview
                    const photoPreview = document.getElementById('currentPhotoPreview');
                    if (photoPreview) {
                        photoPreview.innerHTML = '<span id="photoPlaceholder">No photo</span>';
                    }

                    // Show modal
                    document.getElementById('editEmployeeModal').style.display = 'flex';
                });
            }

            // Close modal
            if (closeDeptModal) {
                closeDeptModal.addEventListener('click', () => {
                    departmentModal.style.display = 'none';
                });
            }

            if (cancelDeptBtn) {
                cancelDeptBtn.addEventListener('click', () => {
                    departmentModal.style.display = 'none';
                });
            }

            // Close modal when clicking outside
            if (departmentModal) {
                departmentModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        departmentModal.style.display = 'none';
                    }
                });
            }

            // Edit department
            window.editDepartment = async function (id, name, description, organizationId) {
                departmentModalTitle.textContent = 'Bo\'limni tahrirlash';
                document.getElementById('deptId').value = id;
                document.getElementById('deptName').value = name || '';
                document.getElementById('deptDescription').value = description || '';
                await loadOrganizationsForSelect();
                if (organizationId) {
                    document.getElementById('deptOrganization').value = organizationId;
                }
                departmentModal.style.display = 'flex';
            };

            // Delete department
            window.deleteDepartment = async function (id, name) {
                if (!confirm(`Haqiqatan ham "${name || 'Bo\'lim'}" ni o'chirmoqchimisiz?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/departments/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Bo\'lim muvaffaqiyatli o\'chirildi!');
                        loadDepartments();
                    } else {
                        alert('Xatolik: ' + (result.message || 'Bo\'limni o\'chirib bo\'lmadi'));
                    }
                } catch (err) {
                    console.error('Error deleting department:', err);
                    alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                }
            };

            // Department form submit
            if (departmentForm) {
                departmentForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const deptId = document.getElementById('deptId').value;
                    const organizationId = document.getElementById('deptOrganization').value;
                    const name = document.getElementById('deptName').value.trim();
                    const description = document.getElementById('deptDescription').value.trim();

                    if (!organizationId) {
                        alert('Tashkilotni tanlang!');
                        return;
                    }

                    if (!name) {
                        alert('Bo\'lim nomini kiriting!');
                        return;
                    }

                    try {
                        const url = deptId ? `/api/departments/${deptId}` : '/api/departments';
                        const method = deptId ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                organization_id: parseInt(organizationId),
                                name: name,
                                description: description || null
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(deptId ? 'Bo\'lim muvaffaqiyatli yangilandi!' : 'Bo\'lim muvaffaqiyatli yaratildi!');
                            departmentModal.style.display = 'none';
                            departmentForm.reset();
                            loadDepartments();
                        } else {
                            alert('Xatolik: ' + (result.message || 'Bo\'limni saqlab bo\'lmadi'));
                        }
                    } catch (err) {
                        console.error('Error saving department:', err);
                        alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                    }
                });
            }

            // Employees Management
            async function loadEmployeesForManagement() {
                try {
                    const response = await fetch('/api/employees', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.employees) {
                            renderEmployeesManagement(result.employees);
                        }
                    }
                } catch (err) {
                    console.error('Error loading employees:', err);
                }
            }

            // Pagination state for employees
            let currentEmployeesPage = 1;
            let employeesPerPage = 5;
            let allEmployeesData = [];

            function calculateRowsPerPage() {
                const listContainer = document.querySelector('#employeesSection .employees-table-container');
                if (!listContainer) return 17;

                // Get available height
                const containerHeight = listContainer.clientHeight;
                const headerHeight = 50; // Approximate header height
                const rowHeight = 50; // Approximate row height
                const availableHeight = containerHeight - headerHeight;

                // Calculate how many rows fit
                const rowsThatFit = Math.floor(availableHeight / rowHeight);

                // Return 17 rows to fill the container, but at least 5
                return Math.max(17, Math.min(rowsThatFit - 1, 17)); // Target 17 rows
            }

            function renderEmployeesManagement(employees) {
                const list = document.getElementById('employeesManagementList');
                if (!list) return;

                // Store all employees data
                allEmployeesData = employees || [];

                if (!employees || employees.length === 0) {
                    list.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: #94a3b8;"><div class="org-empty-state-icon">ðŸ‘¤</div><div class="org-empty-state-text">Hozircha xodimlar mavjud emas</div></td></tr>';
                    if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
                    return;
                }

                // Render all employees (no pagination)
                list.innerHTML = employees.map(emp => {
                    const photo = emp.photo_base64 || emp.photo_url
                        ? `data:image/jpeg;base64,${emp.photo_base64 || ''}`
                        : '';

                    // Format joining date
                    let joiningDate = '-';
                    if (emp.created_at || emp.joining_date) {
                        const date = new Date(emp.created_at || emp.joining_date);
                        if (!isNaN(date.getTime())) {
                            joiningDate = date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
                        }
                    }

                    // Determine status
                    const isActive = !emp.isAbsent && (emp.last_seen_at || emp.lastArrivalTime);
                    const statusClass = isActive ? 'emp-status-active' : 'emp-status-inactive';
                    const statusText = isActive ? 'Faol' : 'Nofaol';

                    // Get initials for avatar
                    const name = emp.full_name || emp.card_name || '';
                    const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || 'U';

                    return `
                <tr>
                    <td>${emp.user_id || emp.id || '-'}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden; background: #f3f4f6; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; flex-shrink: 0;">
                                ${photo ? `<img src="${photo}" style="width: 100%; height: 100%; object-fit: cover;">` : `<span style="font-size: 0.7rem; color: #6b7280; font-weight: 600;">${initials}</span>`}
                            </div>
                            <div style="font-weight: 600; color: #111827; font-size: 0.8rem;">${name || '-'}</div>
                        </div>
                    </td>
                    <td style="font-size: 0.8rem;">${emp.department_name || '-'}</td>
                    <td style="font-size: 0.8rem;">${emp.position || '-'}</td>
                    <td style="font-size: 0.8rem;">${emp.phone || '-'}</td>
                    <td style="font-size: 0.8rem;">${emp.email || '-'}</td>
                    <td style="font-size: 0.8rem;">${joiningDate}</td>
                    <td><span class="emp-status-badge ${statusClass}">${statusText}</span></td>
                    <td class="admin-only">
                        <div class="emp-action-buttons">
                            <button class="emp-btn-edit" onclick="openEditEmployeeModal('${emp.user_id || emp.id}')" title="Tahrirlash">
                                âœï¸
                            </button>
                            <button class="emp-btn-delete" onclick="deleteEmployeeFromManagement('${emp.user_id || emp.id}', '${(name).replace(/'/g, "\\'")}')" title="O'chirish">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
            `;
                }).join('');
                if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
            }

            function handleTableScroll() {
                const listContainer = document.querySelector('#employeesSection .employees-table-container');
                if (!listContainer) return;

                const scrollTop = listContainer.scrollTop;
                const scrollHeight = listContainer.scrollHeight;
                const clientHeight = listContainer.clientHeight;

                // Check if scrolled to bottom (within 50px)
                if (scrollHeight - scrollTop - clientHeight < 50) {
                    const totalPages = Math.ceil(allEmployeesData.length / employeesPerPage);
                    if (currentEmployeesPage < totalPages) {
                        // Auto-advance to next page
                        goToEmployeesPage(currentEmployeesPage + 1);
                    }
                }
            }

            function renderEmployeesPagination(totalPages, totalItems) {
                const paginationContainer = document.getElementById('employeesPagination');
                const paginationNumbers = document.getElementById('empPaginationNumbers');
                const paginationInfo = document.getElementById('empPaginationInfo');
                const prevBtn = document.getElementById('empPaginationPrev');
                const nextBtn = document.getElementById('empPaginationNext');

                if (totalPages <= 1) {
                    paginationContainer.style.display = 'none';
                    return;
                }

                paginationContainer.style.display = 'flex';

                // Update info
                const startItem = (currentEmployeesPage - 1) * employeesPerPage + 1;
                const endItem = Math.min(currentEmployeesPage * employeesPerPage, totalItems);
                paginationInfo.textContent = `${startItem}-${endItem} / ${totalItems}`;

                // Update prev/next buttons
                prevBtn.disabled = currentEmployeesPage === 1;
                nextBtn.disabled = currentEmployeesPage === totalPages;

                // Generate page numbers
                let pageNumbers = [];
                const maxVisible = 5;

                if (totalPages <= maxVisible) {
                    // Show all pages
                    for (let i = 1; i <= totalPages; i++) {
                        pageNumbers.push(i);
                    }
                } else {
                    // Show pages with ellipsis
                    if (currentEmployeesPage <= 3) {
                        // Show first pages
                        for (let i = 1; i <= 4; i++) {
                            pageNumbers.push(i);
                        }
                        pageNumbers.push('...');
                        pageNumbers.push(totalPages);
                    } else if (currentEmployeesPage >= totalPages - 2) {
                        // Show last pages
                        pageNumbers.push(1);
                        pageNumbers.push('...');
                        for (let i = totalPages - 3; i <= totalPages; i++) {
                            pageNumbers.push(i);
                        }
                    } else {
                        // Show middle pages
                        pageNumbers.push(1);
                        pageNumbers.push('...');
                        for (let i = currentEmployeesPage - 1; i <= currentEmployeesPage + 1; i++) {
                            pageNumbers.push(i);
                        }
                        pageNumbers.push('...');
                        pageNumbers.push(totalPages);
                    }
                }

                // Render page number buttons
                paginationNumbers.innerHTML = pageNumbers.map(page => {
                    if (page === '...') {
                        return `<span style="padding: 0 8px; color: #9ca3af;">...</span>`;
                    }
                    const isActive = page === currentEmployeesPage;
                    return `<button class="emp-pagination-btn ${isActive ? 'active' : ''}" onclick="goToEmployeesPage(${page})">${page}</button>`;
                }).join('');
            }

            window.goToEmployeesPage = function (page) {
                if (page === currentEmployeesPage) return;
                currentEmployeesPage = page;
                renderEmployeesManagement(allEmployeesData);

                // Scroll to top when page changes
                setTimeout(() => {
                    const listContainer = document.querySelector('#employeesSection .employees-table-container');
                    if (listContainer) {
                        listContainer.scrollTop = 0;
                    }
                }, 50);
            };

            window.changeEmployeesPage = function (direction) {
                const totalPages = Math.ceil(allEmployeesData.length / employeesPerPage);
                const newPage = currentEmployeesPage + direction;
                if (newPage >= 1 && newPage <= totalPages) {
                    goToEmployeesPage(newPage);
                }
            };

            function updateEmployeeStats(employees) {
                if (!employees) return;

                const total = employees.length;
                const active = employees.filter(e => !e.isAbsent && (e.last_seen_at || e.lastArrivalTime)).length;
                const inactive = employees.filter(e => e.isAbsent || !(e.last_seen_at || e.lastArrivalTime)).length;

                // New joiners (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const newJoiners = employees.filter(e => {
                    const created = e.created_at || e.joining_date;
                    if (!created) return false;
                    return new Date(created) >= thirtyDaysAgo;
                }).length;

                const totalEl = document.getElementById('empTotalCount');
                const activeEl = document.getElementById('empActiveCount');
                const inactiveEl = document.getElementById('empInactiveCount');
                const newEl = document.getElementById('empNewCount');

                if (totalEl) totalEl.textContent = total;
                if (activeEl) activeEl.textContent = active;
                if (inactiveEl) inactiveEl.textContent = inactive;
                if (newEl) newEl.textContent = newJoiners;
            }

            // Export employees to Excel
            window.exportEmployeesToExcel = async function () {
                try {
                    // Get employees data
                    const response = await fetch('/api/employees', {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        alert('Xodimlar ma\'lumotlarini yuklab bo\'lmadi');
                        return;
                    }

                    const result = await response.json();
                    const employees = result.success && result.employees ? result.employees : [];

                    if (employees.length === 0) {
                        alert('Eksport qilish uchun xodimlar mavjud emas');
                        return;
                    }

                    // Prepare data for Excel
                    const headers = ['ID', 'Ism Familiya', 'Bo\'lim', 'Lavozim', 'Oxirgi faollik', 'Jami tashriflar'];
                    const rows = [headers];

                    employees.forEach(emp => {
                        let lastActivity = '-';
                        if (emp.last_seen_at || emp.lastArrivalTime) {
                            const lastSeen = emp.last_seen_at || emp.lastArrivalTime;
                            const date = new Date(lastSeen);
                            if (!isNaN(date.getTime())) {
                                const dateStr = date.toLocaleDateString('uz-UZ', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const timeStr = date.toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' });
                                lastActivity = `${dateStr} ${timeStr}`;
                            }
                        }

                        rows.push([
                            emp.user_id || emp.id || '-',
                            emp.full_name || emp.card_name || '-',
                            emp.department_name || '-',
                            emp.position || '-',
                            lastActivity,
                            emp.total_visits || 0
                        ]);
                    });

                    // Create workbook and worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(rows);

                    // Set column widths
                    const colWidths = [
                        { wch: 10 }, // ID
                        { wch: 25 }, // Ism Familiya
                        { wch: 20 }, // Bo'lim
                        { wch: 20 }, // Lavozim
                        { wch: 20 }, // Oxirgi faollik
                        { wch: 15 }  // Jami tashriflar
                    ];
                    ws['!cols'] = colWidths;

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Xodimlar');

                    // Generate filename with date
                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0];
                    const filename = `Xodimlar_${dateStr}.xlsx`;

                    // Write file and download
                    XLSX.writeFile(wb, filename);

                } catch (err) {
                    console.error('Error exporting employees:', err);
                    alert('Excel faylini yaratishda xatolik yuz berdi');
                }
            };

            window.openEditEmployeeModal = async function (userId) {
                try {
                    const response = await fetch(`/api/employees/${userId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.employee) {
                            const emp = result.employee;

                            document.getElementById('editUserId').value = emp.user_id || emp.id;
                            document.getElementById('editFullName').value = emp.full_name || emp.card_name || '';
                            document.getElementById('editPhone').value = emp.phone || '';
                            document.getElementById('editEmail').value = emp.email || '';

                            // Load departments and positions for dropdowns
                            await loadDepartmentsForEmployeeSelect();
                            await loadPositionsForEmployeeSelect();

                            // Set selected values
                            if (emp.position) {
                                document.getElementById('editPosition').value = emp.position;
                            }
                            if (emp.department_id) {
                                document.getElementById('editDepartment').value = emp.department_id;
                            }

                            // Set photo preview
                            const photoPreview = document.getElementById('currentPhotoPreview');
                            const photoPlaceholder = document.getElementById('photoPlaceholder');
                            if (emp.photo_base64 || emp.photo_url) {
                                photoPreview.innerHTML = `<img src="data:image/jpeg;base64,${emp.photo_base64 || ''}" style="width: 100%; height: 100%; object-fit: cover;">`;
                            } else {
                                photoPreview.innerHTML = '<span id="photoPlaceholder">No photo</span>';
                            }

                            document.getElementById('editEmployeeModal').style.display = 'flex';
                        }
                    }
                } catch (err) {
                    console.error('Error loading employee:', err);
                    alert('Xodim ma\'lumotlarini yuklab bo\'lmadi');
                }
            };

            async function loadDepartmentsForEmployeeSelect() {
                try {
                    const response = await fetch('/api/departments', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const select = document.getElementById('editDepartment');
                        if (select && result.success && result.departments) {
                            select.innerHTML = '<option value="">Bo\'limni tanlang</option>' +
                                result.departments.map(dept =>
                                    `<option value="${dept.id}">${dept.name}</option>`
                                ).join('');
                        }
                    }
                } catch (err) {
                    console.error('Error loading departments:', err);
                }
            }

            async function loadPositionsForEmployeeSelect() {
                try {
                    const response = await fetch('/api/positions', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const select = document.getElementById('editPosition');
                        if (select && result.success && result.positions) {
                            select.innerHTML = '<option value="">Lavozimni tanlang</option>' +
                                result.positions.map(pos =>
                                    `<option value="${pos.name}">${pos.name}</option>`
                                ).join('');
                        }
                    }
                } catch (err) {
                    console.error('Error loading positions:', err);
                }
            }

            window.deleteEmployeeFromManagement = async function (userId, name) {
                if (!confirm(`"${name}" xodimini o'chirishni tasdiqlaysizmi?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/employees/${userId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            alert('Xodim muvaffaqiyatli o\'chirildi');
                            loadEmployeesForManagement();
                        } else {
                            alert('Xatolik: ' + (result.message || 'Xodimni o\'chirib bo\'lmadi'));
                        }
                    }
                } catch (err) {
                    console.error('Error deleting employee:', err);
                    alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                }
            };

            // Positions Management
            const positionsSection = document.getElementById('positionsSection');
            const createPositionBtn = document.getElementById('createPositionBtn');
            const positionsList = document.getElementById('positionsList');
            const positionModal = document.getElementById('positionModal');
            const positionForm = document.getElementById('positionForm');
            const positionModalTitle = document.getElementById('positionModalTitle');
            const closePositionModal = document.getElementById('closePositionModal');
            const cancelPositionBtn = document.getElementById('cancelPositionBtn');

            async function loadPositions() {
                try {
                    const response = await fetch('/api/positions', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.positions) {
                            renderPositions(result.positions);
                        } else {
                            const tbody = document.getElementById('positionsTableBody');
                            if (tbody) {
                                tbody.innerHTML = '<tr><td colspan="4" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ’¼</div><div class="org-empty-state-text">Hozircha lavozimlar mavjud emas</div></div></td></tr>';
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error loading positions:', err);
                    const tbody = document.getElementById('positionsTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="4" style="padding: 40px; text-align: center; color: #ef4444;"><div class="org-error-state"><div class="org-empty-state-icon">âš ï¸</div><div class="org-empty-state-text">Xatolik yuz berdi. Qayta urinib ko\'ring.</div></div></td></tr>';
                    }
                }
            }

            function renderPositions(positions) {
                const tbody = document.getElementById('positionsTableBody');
                if (!tbody) return;

                if (!positions || positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 40px; text-align: center; color: #6b7280;"><div class="org-empty-state"><div class="org-empty-state-icon">ðŸ’¼</div><div class="org-empty-state-text">Hozircha lavozimlar mavjud emas</div></div></td></tr>';
                    if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
                    return;
                }

                tbody.innerHTML = positions.map((pos, index) => `
            <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background=''">
                <td style="padding: 12px 16px; color: #6b7280; font-weight: 500;">${index + 1}</td>
                <td style="padding: 12px 16px; color: #111827; font-weight: 600;">${pos.name || '-'}</td>
                <td style="padding: 12px 16px; color: #111827;">${pos.description || 'Tavsif ko\'rsatilmagan'}</td>
                <td class="admin-only" style="padding: 12px 16px; text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <button onclick="editPosition(${pos.id}, '${(pos.name || '').replace(/'/g, "\\'")}', '${(pos.description || '').replace(/'/g, "\\'")}')" style="padding: 6px 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Tahrirlash">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: white;">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button onclick="deletePosition(${pos.id}, '${(pos.name || '').replace(/'/g, "\\'")}')" style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="O'chirish">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; fill: white;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
                if (typeof applyAdminOnlyVisibility === 'function') applyAdminOnlyVisibility();
            }

            if (createPositionBtn) {
                createPositionBtn.addEventListener('click', () => {
                    positionModalTitle.textContent = 'Lavozim yaratish';
                    positionForm.reset();
                    document.getElementById('positionId').value = '';
                    positionModal.style.display = 'flex';
                });
            }

            if (closePositionModal) {
                closePositionModal.addEventListener('click', () => {
                    positionModal.style.display = 'none';
                });
            }

            if (cancelPositionBtn) {
                cancelPositionBtn.addEventListener('click', () => {
                    positionModal.style.display = 'none';
                });
            }

            if (positionModal) {
                positionModal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        positionModal.style.display = 'none';
                    }
                });
            }

            window.editPosition = function (id, name, description) {
                positionModalTitle.textContent = 'Lavozimni tahrirlash';
                document.getElementById('positionId').value = id;
                document.getElementById('positionName').value = name || '';
                document.getElementById('positionDescription').value = description || '';
                positionModal.style.display = 'flex';
            };

            window.deletePosition = async function (id, name) {
                if (!confirm(`"${name}" lavozimini o'chirishni tasdiqlaysizmi?`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/positions/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            alert('Lavozim muvaffaqiyatli o\'chirildi');
                            loadPositions();
                        } else {
                            alert('Xatolik: ' + (result.message || 'Lavozimni o\'chirib bo\'lmadi'));
                        }
                    }
                } catch (err) {
                    console.error('Error deleting position:', err);
                    alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                }
            };

            if (positionForm) {
                positionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const id = document.getElementById('positionId').value;
                    const name = document.getElementById('positionName').value.trim();
                    const description = document.getElementById('positionDescription').value.trim();

                    if (!name) {
                        alert('Lavozim nomi kiritilishi shart');
                        return;
                    }

                    try {
                        const url = id ? `/api/positions/${id}` : '/api/positions';
                        const method = id ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({ name, description })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                alert(id ? 'Lavozim muvaffaqiyatli yangilandi' : 'Lavozim muvaffaqiyatli yaratildi');
                                positionModal.style.display = 'none';
                                loadPositions();
                            } else {
                                alert('Xatolik: ' + (result.message || 'Lavozimni saqlab bo\'lmadi'));
                            }
                        }
                    } catch (err) {
                        console.error('Error saving position:', err);
                        alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                    }
                });
            }

            // Super Admin Settings Functions
            let superAdminPhotoFile = null;

            function handleSuperAdminPhotoChange(event) {
                const file = event.target.files[0];
                if (file) {
                    superAdminPhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.getElementById('superAdminPhotoImg');
                        const preview = document.getElementById('superAdminPhotoPreview');
                        img.src = e.target.result;
                        img.style.display = 'block';
                        preview.querySelector('span').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            }

            function resetSuperAdminForm() {
                document.getElementById('superAdminForm').reset();
                superAdminPhotoFile = null;
                const img = document.getElementById('superAdminPhotoImg');
                const preview = document.getElementById('superAdminPhotoPreview');
                img.src = '';
                img.style.display = 'none';
                preview.querySelector('span').style.display = 'block';
                loadSuperAdminData();
            }

            async function loadSuperAdminData() {
                try {
                    const response = await fetch('/api/users/me', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.user) {
                            const user = result.user;

                            // Fill form fields
                            document.getElementById('superAdminFirstName').value = user.first_name || '';
                            document.getElementById('superAdminLastName').value = user.last_name || '';
                            document.getElementById('superAdminUsername').value = user.username || '';
                            document.getElementById('superAdminEmail').value = user.email || '';
                            document.getElementById('superAdminPhone').value = user.phone || '';
                            document.getElementById('superAdminAddress').value = user.address || '';

                            // Birth date
                            if (user.birth_date) {
                                const birthDate = new Date(user.birth_date);
                                document.getElementById('superAdminBirthYear').value = birthDate.getFullYear() || '';
                                document.getElementById('superAdminBirthMonth').value = (birthDate.getMonth() + 1) || '';
                                document.getElementById('superAdminBirthDay').value = birthDate.getDate() || '';
                            }

                            // Photo
                            if (user.photo) {
                                const img = document.getElementById('superAdminPhotoImg');
                                const preview = document.getElementById('superAdminPhotoPreview');
                                img.src = user.photo;
                                img.style.display = 'block';
                                preview.querySelector('span').style.display = 'none';
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error loading super admin data:', err);
                }
            }

            // Load data when settings section is shown
            document.addEventListener('DOMContentLoaded', () => {
                const settingsSection = document.getElementById('settingsSection');
                if (settingsSection) {
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                if (settingsSection.style.display !== 'none') {
                                    loadSuperAdminData();
                                }
                            }
                        });
                    });
                    observer.observe(settingsSection, { attributes: true, attributeFilter: ['style'] });
                }

                // Form submit handler
                const superAdminForm = document.getElementById('superAdminForm');
                if (superAdminForm) {
                    superAdminForm.addEventListener('submit', async (e) => {
                        e.preventDefault();

                        const formData = new FormData();
                        formData.append('first_name', document.getElementById('superAdminFirstName').value);
                        formData.append('last_name', document.getElementById('superAdminLastName').value);
                        formData.append('username', document.getElementById('superAdminUsername').value);

                        const password = document.getElementById('superAdminPassword').value;
                        if (password) {
                            formData.append('password', password);
                        }

                        formData.append('email', document.getElementById('superAdminEmail').value);
                        formData.append('phone', document.getElementById('superAdminPhone').value);
                        formData.append('address', document.getElementById('superAdminAddress').value);

                        // Birth date
                        const year = document.getElementById('superAdminBirthYear').value;
                        const month = document.getElementById('superAdminBirthMonth').value;
                        const day = document.getElementById('superAdminBirthDay').value;
                        if (year && month && day) {
                            formData.append('birth_date', `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`);
                        }

                        // Photo
                        if (superAdminPhotoFile) {
                            formData.append('photo', superAdminPhotoFile);
                        }

                        try {
                            const response = await fetch('/api/users/me', {
                                method: 'PUT',
                                credentials: 'include',
                                body: formData
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    alert('Ma\'lumotlar muvaffaqiyatli saqlandi');
                                    superAdminPhotoFile = null;
                                    loadSuperAdminData();
                                } else {
                                    alert('Xatolik: ' + (result.message || 'Ma\'lumotlarni saqlab bo\'lmadi'));
                                }
                            } else {
                                const result = await response.json();
                                alert('Xatolik: ' + (result.message || 'Server xatosi'));
                            }
                        } catch (err) {
                            console.error('Error saving super admin data:', err);
                            alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                        }
                    });
                }

                // Super Admin Info Modal
                const superAdminInfoModal = document.getElementById('superAdminInfoModal');
                const closeSuperAdminInfoModal = document.getElementById('closeSuperAdminInfoModal');

                if (closeSuperAdminInfoModal) {
                    closeSuperAdminInfoModal.addEventListener('click', () => {
                        superAdminInfoModal.style.display = 'none';
                    });
                }

                if (superAdminInfoModal) {
                    superAdminInfoModal.addEventListener('click', function (e) {
                        if (e.target === this) {
                            superAdminInfoModal.style.display = 'none';
                        }
                    });
                }
            });

            // Open Super Admin Info Modal with Edit functionality
            window.openSuperAdminInfoModal = async function () {
                const modal = document.getElementById('superAdminInfoModal');
                const content = document.getElementById('superAdminInfoContent');
                const loading = document.getElementById('superAdminInfoLoading');

                if (!modal || !content) return;

                modal.style.display = 'flex';
                loading.style.display = 'block';
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Ma\'lumotlar yuklanmoqda...</div>';

                try {
                    const response = await fetch('/api/users/me', {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.user) {
                            const user = result.user;
                            const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ') || user.username || 'A.Turdiyev';
                            const roleDisplay = user.role === 'superadmin' ? 'SUPER ADMIN' : (user.role === 'admin' ? 'ADMIN' : (user.role === 'kadr' ? 'KADR' : 'FOYDALANUVCHI'));

                            // Format birth date for input
                            let birthDateInput = '';
                            if (user.birth_date) {
                                const birthDate = new Date(user.birth_date);
                                birthDateInput = birthDate.toISOString().split('T')[0];
                            }

                            content.innerHTML = `
                        <div class="profile-summary">
                            <div class="profile-avatar" id="userPhotoPreviewWrap">
                                ${user.photo ? `<img id="userPhotoPreview" src="${user.photo}" alt="Profil rasmi">` : '<span class="no-photo">Rasm yo\'q</span>'}
                            </div>
                            <div class="profile-meta">
                                <h2>${fullName}</h2>
                                <span class="profile-badge">${roleDisplay}</span>
                                <p class="profile-username">${user.username || 'â€”'}</p>
                            </div>
                        </div>
                        <div class="profile-tabs">
                            <button type="button" class="profile-tab active" data-tab="shaxsiy">Shaxsiy</button>
                            <button type="button" class="profile-tab" data-tab="aloqa">Aloqa</button>
                            <button type="button" class="profile-tab" data-tab="hisob">Hisob</button>
                        </div>
                        <form id="userProfileForm">
                            <div id="panel-shaxsiy" class="profile-panel active">
                                <div class="profile-grid">
                                    <div class="profile-field">
                                        <label>Ism</label>
                                        <input type="text" id="editFirstName" value="${(user.first_name || '').replace(/"/g, '&quot;')}" placeholder="Ism">
                                    </div>
                                    <div class="profile-field">
                                        <label>Familiya</label>
                                        <input type="text" id="editLastName" value="${(user.last_name || '').replace(/"/g, '&quot;')}" placeholder="Familiya">
                                    </div>
                                    <div class="profile-field">
                                        <label>Tug'ilgan sana</label>
                                        <input type="date" id="editBirthDate" value="${birthDateInput}">
                                    </div>
                                    <div class="profile-field">
                                        <label>Profil rasmi</label>
                                        <div class="profile-file-wrap">
                                            <input type="file" id="editPhoto" accept="image/*" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;">
                                            <button type="button" class="profile-file-btn" id="editPhotoBtn">Fayl tanlash</button>
                                            <span class="profile-file-name" id="editPhotoLabel">Fayl tanlanmadi</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="panel-aloqa" class="profile-panel">
                                <div class="profile-grid">
                                    <div class="profile-field">
                                        <label>Email</label>
                                        <input type="email" id="editEmail" value="${(user.email || '').replace(/"/g, '&quot;')}" placeholder="Email">
                                    </div>
                                    <div class="profile-field">
                                        <label>Telefon raqami</label>
                                        <input type="tel" id="editPhone" value="${(user.phone || '').replace(/"/g, '&quot;')}" placeholder="+998 90 123 45 67">
                                    </div>
                                    <div class="profile-field" style="grid-column: 1 / -1;">
                                        <label>Manzil</label>
                                        <input type="text" id="editAddress" value="${(user.address || '').replace(/"/g, '&quot;')}" placeholder="Manzil">
                                    </div>
                                </div>
                            </div>
                            <div id="panel-hisob" class="profile-panel">
                                <div class="profile-grid">
                                    <div class="profile-field">
                                        <label>Login</label>
                                        <input type="text" id="editUsername" value="${(user.username || '').replace(/"/g, '&quot;')}" placeholder="Foydalanuvchi nomi">
                                    </div>
                                    <div class="profile-field">
                                        <label>Yangi parol (ixtiyoriy)</label>
                                        <input type="password" id="editPassword" placeholder="Parolni o'zgartirish">
                                    </div>
                                    <div class="profile-field">
                                        <label>Rol</label>
                                        <input type="text" value="${roleDisplay}" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="profile-actions">
                                <button type="button" class="btn-cancel" id="profileModalCancelBtn">Bekor qilish</button>
                                <button type="submit" class="btn-save">Saqlash</button>
                            </div>
                        </form>
                    `;

                            // Tab switch
                            document.querySelectorAll('.profile-tab').forEach(function(tab) {
                                tab.addEventListener('click', function() {
                                    const t = this.getAttribute('data-tab');
                                    document.querySelectorAll('.profile-tab').forEach(function(x) { x.classList.remove('active'); });
                                    document.querySelectorAll('.profile-panel').forEach(function(p) { p.classList.remove('active'); });
                                    this.classList.add('active');
                                    const panel = document.getElementById('panel-' + t);
                                    if (panel) panel.classList.add('active');
                                });
                            });

                            // File input: custom button + label (o'zbekcha, ruscha olib tashlandi)
                            const photoInput = document.getElementById('editPhoto');
                            const photoBtn = document.getElementById('editPhotoBtn');
                            const photoLabel = document.getElementById('editPhotoLabel');
                            const photoWrap = document.getElementById('userPhotoPreviewWrap');
                            if (photoBtn && photoInput) {
                                photoBtn.addEventListener('click', function() { photoInput.click(); });
                            }
                            if (photoInput && photoWrap && photoLabel) {
                                photoInput.addEventListener('change', function(e) {
                                    const file = e.target.files[0];
                                    if (file) {
                                        photoLabel.textContent = file.name;
                                        const reader = new FileReader();
                                        reader.onload = function(ev) {
                                            photoWrap.innerHTML = '<img id="userPhotoPreview" src="' + ev.target.result + '" alt="Profil rasmi">';
                                        };
                                        reader.readAsDataURL(file);
                                    } else {
                                        photoLabel.textContent = 'Fayl tanlanmadi';
                                    }
                                });
                            }

                            const cancelBtn = document.getElementById('profileModalCancelBtn');
                            if (cancelBtn) {
                                cancelBtn.addEventListener('click', function() {
                                    document.getElementById('superAdminInfoModal').style.display = 'none';
                                });
                            }

                            // Handle form submission
                            const form = document.getElementById('userProfileForm');
                            if (form) {
                                form.addEventListener('submit', async function(e) {
                                    e.preventDefault();
                                    
                                    const formData = new FormData();
                                    formData.append('first_name', document.getElementById('editFirstName').value);
                                    formData.append('last_name', document.getElementById('editLastName').value);
                                    formData.append('username', document.getElementById('editUsername').value);
                                    formData.append('email', document.getElementById('editEmail').value);
                                    formData.append('phone', document.getElementById('editPhone').value);
                                    formData.append('address', document.getElementById('editAddress').value);
                                    formData.append('birth_date', document.getElementById('editBirthDate').value);
                                    
                                    const password = document.getElementById('editPassword').value;
                                    if (password) {
                                        formData.append('password', password);
                                    }
                                    
                                    const photoFile = document.getElementById('editPhoto').files[0];
                                    if (photoFile) {
                                        formData.append('photo', photoFile);
                                    }

                                    try {
                                        const submitBtn = form.querySelector('button[type="submit"]');
                                        submitBtn.disabled = true;
                                        submitBtn.textContent = 'Saqlanmoqda...';

                                        const response = await fetch('/api/users/me', {
                                            method: 'PUT',
                                            credentials: 'include',
                                            body: formData
                                        });

                                        const result = await response.json();
                                        
                                        if (result.success) {
                                            alert('Ma\'lumotlar muvaffaqiyatli yangilandi');
                                            modal.style.display = 'none';
                                            // Reload user info
                                            if (typeof updateUserInfo === 'function') {
                                                updateUserInfo();
                                            }
                                            // Reload page to update header
                                            window.location.reload();
                                        } else {
                                            alert('Xatolik: ' + (result.message || 'Ma\'lumotlarni yangilab bo\'lmadi'));
                                            submitBtn.disabled = false;
                                            submitBtn.textContent = 'Saqlash';
                                        }
                                    } catch (err) {
                                        console.error('Error updating user:', err);
                                        alert('Xatolik: Server bilan aloqa o\'rnatib bo\'lmadi');
                                        const submitBtn = form.querySelector('button[type="submit"]');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = 'Saqlash';
                                    }
                                });
                            }
                        } else {
                            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Ma\'lumotlarni yuklab bo\'lmadi</div>';
                        }
                    } else {
                        content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Xatolik yuz berdi</div>';
                    }
                } catch (err) {
                    console.error('Error loading user info:', err);
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Server bilan aloqa o\'rnatib bo\'lmadi</div>';
                } finally {
                    loading.style.display = 'none';
                }
            };
        </script>
    </div>
    </div>
</body>

</html>